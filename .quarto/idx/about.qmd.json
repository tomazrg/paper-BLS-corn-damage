{"title":"Packages","markdown":{"yaml":{"title":"","message":false,"warning":false},"headingText":"Packages","containsRefs":false,"markdown":"\n\n\n```{r}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(gsheet)\nlibrary(lme4)\nlibrary(cowplot)\nlibrary(readxl)\nlibrary(writexl)\nlibrary(ggdist)\n```\n\n# Importation\n\n```{r}\ngls = gsheet2tbl(\"https://docs.google.com/spreadsheets/d/1TC_-I7OpUloaqh5sd3mVu8YW-V1Lxk8SZ_DRCIUmWOE/edit?usp=sharing\")\n\n```\n\n# Descriptive analysis\n\n## Severity\n\n```{r}\n\nplot_sev = gls %>% \n  ggplot(aes(sev))+\n  geom_histogram(color = \"white\", fill = \"black\")+\n  #stat_function(fun=function(x) dbeta(x, 0.94145, 6.45601), color= \"darkred\", size = 1.2)+\n  ggthemes::theme_few()+\n  labs(x = \"Disease severity (%)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"))\n\n```\n\n\n## Yield\n\n```{r}\nyy = gls %>% \n  filter(!yld <= 1500)\n\nmean(gls$yld)\nmax(gls$yld)\nmin(yy$yld)\n\nquantile(yy$yld)\n```\n\n\n```{r}\n\nmean_intercept = mean(gls$yld)\nsd_intercept = sd(gls$yld)\n\nplot_yld = gls %>% \n  filter(!yld <=1000) %>% \n  ggplot(aes(yld))+\ngeom_histogram(fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  scale_x_continuous(breaks = c(4000, 6000,8000,10000,12000, 14000), limits = c(4000, 14000))+\n  ggthemes::theme_few()+\n  labs(x = \"Yield (kg/ha)\",\n       y = \"\")+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"))\n\nplot_yld\n```\n\n```{r}\nplot_grid(plot_sev, plot_yld, ncol = 2, label_x = -0.03, label_size = 14,\n          labels = c(\"(a)\",\"(b)\"))\nggsave(\"fig/sev_yld.png\", bg = \"white\", dpi = 600, \n       width = 8, height = 4)\n\n```\n\n## Prepare data\n\n```{r}\nestria2 <- gls |> \n  group_by(trial, hybrid) |> \n  summarise(mean_sev = mean(sev),\n            mean_yld = mean(yld))\n\n\nmax(estria2$mean_sev)\nmin(estria2$mean_sev)\nmean(estria2$mean_sev)\nmedian(estria2$mean_sev)\nsd(estria2$mean_sev)\n\nmax(estria2$mean_yld)\nmin(estria2$mean_yld)\nmean(estria2$mean_yld)\nmedian(estria2$mean_yld)\nsd(estria2$mean_yld)\n```\n\n## Visualize\n\n```{r}\n\nestria2 = estria2 %>% \n  mutate(\n    period = case_when(trial == \"2018_1\"~ \"2018/1\",\n                       trial == \"2018_2\" ~\"2018/2\",\n                       trial == \"2018_19\"~\"2018/2019\",\n                       trial == \"2019_1\" ~\"2019/1\"))\nlibrary(ggthemes)\n\n trials = estria2 |>\n  ggplot(aes(mean_sev, mean_yld, group = as.factor(period),color = as.factor(period)))+ #\n  geom_point()+\n  #facet_wrap(~period)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2)+\n  scale_color_viridis_d()+\n  theme_minimal()+\n   scale_y_continuous(breaks = c(4000, 5000,6000,7000,8000,9000,10000,11000,12000), \n                     limits = c(4000, 12000))+\n  theme_few()+\n  labs(x = \"Disease severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Seasons\")+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        legend.position = \"none\")\n  #geom_abline(slope = -49.3, intercept = 9714, linetype = 1, linewidth =2, color = \"gray50\")\n\nggsave(\"fig/trials.png\", bg = \"white\", dpi = 600, \n       width = 6, height = 4)\n\n```\n\n```{r}\nlibrary(broom)\nlmer_stats = estria2 %>%\n  #group_by(year) %>%\n  dplyr::select(trial, mean_yld,mean_sev) %>%\n  group_by(trial) %>%\n  do({\n    model <- lm(.$mean_yld ~ .$mean_sev)\n    tidy_model <- tidy(model)\n    confint_model <- confint(model)  # Calcula os intervalos de confiança\n    bind_cols(tidy_model, confint_model)\n  })\n\n\n\n\nlmer_stats = lmer_stats |> \nfilter(term %in% c(\"(Intercept)\",\".$mean_sev\"))\n \nlmer_stats[lmer_stats$term== \"(Intercept)\",c(\"parameters\")] <- \"Intercept\"\nlmer_stats[lmer_stats$term== \".$mean_sev\",c(\"parameters\")] <- \"Slope\"\n\ni <- 1\n while (i <= nrow(lmer_stats)) {\n  if (lmer_stats$parameters[i] == \"Slope\" && lmer_stats$estimate[i] > 0) {\n    # Remove a linha do Slope e a linha do Intercept correspondente\n    lmer_stats <- lmer_stats[-c(i, i - 1), ]\n    # Atualiza o índice, pois duas linhas foram removidas\n    i <- i - 2\n  }\n  i <- i + 1\n }\nlmer_stats\n\n\nslope_trial_m= lmer_stats |> \n  filter(parameters == \"Slope\") %>% \n  summarise(\n    Slope = estimate\n  )\n\nslope_trial_m[,1] = NULL\n\nslope_trial_m |> \n  filter(!Slope == \"NA\") |> \n  summarise(\nmean = mean(Slope))\n\nintercept_trial_m = lmer_stats |> \n  filter(parameters == \"Intercept\") %>%  \n  summarise(\n    Intercept = estimate\n  )\nintercept_trial_m[,1] = NULL\n\nmean(intercept_trial_m$Intercept)\n\nregression_trial_m = cbind(slope_trial_m,intercept_trial_m)\nregression_trial_m[,3] = NULL\n\nsummary_stats <- regression_trial_m %>%\n  reframe(\n    mean_intercept = mean(Intercept),\n    mean_slope = mean(Slope),\n    ci_intercept_lower = quantile(Intercept, 0.025),\n    ci_intercept_upper = quantile(Intercept, 0.975),\n    ci_slope_lower = quantile(Slope, 0.025),\n    ci_slope_upper = quantile(Slope, 0.975)\n  )\n\ntrials = estria2|> \n ggplot(aes(mean_sev, y = mean_yld)) +\n  geom_point(color = \"NA\")+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  geom_abline(data =regression_trial_m, aes(slope = Slope, intercept = Intercept), size = 1,\n              alpha = 0.5, color = \"grey\")+##9ccb86\n  #geom_abline(data =summary_stats, aes(slope = mean_slope, intercept = mean_intercept),\n   #           size = 1.5, fill = \"black\", color = \"black\")+\ngeom_abline(data = summary_stats,aes(intercept = ci_intercept_lower,slope = ci_slope_lower) ,\n              size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(data = summary_stats, aes(intercept = ci_intercept_upper,slope = ci_slope_upper), size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(aes(slope = -49.37, intercept = 9714.0),\n              size = 1.5, fill = \"black\", color = \"black\")+\ngeom_abline(aes(intercept = 8699.1,slope = -60.59) ,\n              size = .51, linetype = 2)+\n  geom_abline(aes(intercept = 10733.8,slope = -38.00), size = .51, linetype = 2)+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\", y = \"Attainable yield (kg/ha)\",\n       title = \"\")\n```\n\n```{r}\nfirst_plot = estria2 |> \n  filter(trial == \"2018_1\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nsecond_plot = estria2 |> \n  filter(trial == \"2018_2\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nthird_plot = estria2 |> \n  filter(trial == \"2018_19\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nfourth_plot = estria2 |> \n  filter(trial == \"2019_1\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlibrary(patchwork)\n\ncombined_plot <- (first_plot | plot_yld | second_plot) / \n                 (third_plot | plot_sev | fourth_plot) +\n                 plot_layout(widths = c(2, 10, 2), heights = c(1, 1))\ncombined_plot\nggsave(\"fig/plot_all.png\", bg = \"white\", width = 10, height = 8)\n```\n\n# Modeling\n\n\n### Fitting\n\n```{r}\nlibrary(lme4)\n\n# Fit a mixed-effects model\nobs_model_lmer <- lmer(mean_yld ~ mean_sev + (1 | trial), data = estria2)\n\n\n# Summary of the model\nsummary(obs_model_lmer)\nconfint(obs_model_lmer)\n\nset.seed(1234)\n\n# Parameters from the fitted model\nfixed_intercept <- 9714.049\nfixed_slope <- -49.378\nrandom_effect_sd <- 905.9  # sqrt(820678)\nresidual_sd <- 970.4       # sqrt(941736)\n\n# Number of experiments and points per experiment\nnum_experiments <- 200  # New experiments\npoints_per_experiment <- 50\n\n# Simulate data\n# Get the range of observed severity values from the original dataset\nset.seed(123)\n\n# Simulate data with variable max severity for each experiment\nsimulated_data_lmer <- data.frame()\nfor (exp in 1:num_experiments) {\n  # Simulate random intercept for the experiment\n  u_j <- rnorm(1, mean = 0, sd = random_effect_sd)\n  \n  # Randomly select a max severity for this simulation between 50% and 80%\n  max_sev_sim <- runif(1, min = 20, max = 80)\n  \n  # Simulate severity values (independent variable) within the 0 to max_sev_sim range\n  sev <- runif(points_per_experiment, min = 0, max = max_sev_sim)\n\n  # Simulate residuals\n  residuals <- rnorm(points_per_experiment, mean = 0, sd = residual_sd)\n  \n  # Generate yield (dependent variable)\n  yld <- fixed_intercept + u_j + fixed_slope * sev + residuals\n  \n  # Combine into a data frame\n  exp_data <- data.frame(experiment = paste0(\"Exp_\", exp), sev = sev, yld = yld)\n  simulated_data_lmer <- rbind(simulated_data_lmer, exp_data)\n}\n\nsimulated_data_lmer$hybrid <- paste0(\"hybrid_\", sprintf(\"%02d\", (seq_len(nrow(simulated_data_lmer)) - 1) %/% 50 + 1))\n# View simulated data\nhead(simulated_data_lmer)\n\nsummary(simulated_data_lmer)\n\nlibrary(ggplot2)\n\n# Compare simulated and real severity-yield relationships\nggplot(simulated_data_lmer, aes(x = sev, y = yld, color = experiment)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  theme_minimal() +\n  theme(legend.position = \"none\")+\n  labs(title = \"Simulated Severity-Yield Data\", x = \"Severity\", y = \"Yield\")\n\n\nsimu_model_lmer <- lmer(yld ~ sev + (1 | experiment), data = simulated_data_lmer)\nsimu_model_lmer\nsummary(simu_model_lmer)\nconfint(simu_model_lmer)\n\n\nobs_fixed_effects_lmer <- fixef(obs_model_lmer)  # From the original model\nsimu_fixed_effects_lmer <- fixef(simu_model_lmer)  # From the simulated model\n\nprint(obs_fixed_effects_lmer)\nprint(simu_fixed_effects_lmer)\n\n\nobs_random_effects_lmer <- VarCorr(obs_model_lmer)\nsimu_random_effects_lmer <- VarCorr(simu_model_lmer)\n\nprint(obs_random_effects_lmer)\nprint(simu_random_effects_lmer)\n\n\nobs_residual_sd_lmer <- attr(VarCorr(obs_model_lmer), \"sc\")\nsimu_residual_sd_lmer <- attr(VarCorr(simu_model_lmer), \"sc\")\n\nprint(obs_residual_sd_lmer)\nprint(simu_residual_sd_lmer)\n\n```\n## Plotting\n```{r}\nlibrary(broom)\nlmer_stats = simulated_data_lmer %>%\n  #group_by(year) %>%\n  dplyr::select(experiment, yld,sev) %>%\n  group_by(experiment) %>%\n  do({\n    model <- lm(.$yld ~ .$sev)\n    tidy_model <- tidy(model)\n    confint_model <- confint(model)  # Calcula os intervalos de confiança\n    bind_cols(tidy_model, confint_model)\n  })\n\n\n\n\nlmer_stats = lmer_stats |> \nfilter(term %in% c(\"(Intercept)\",\".$sev\"))\n \nlmer_stats[lmer_stats$term== \"(Intercept)\",c(\"parameters\")] <- \"Intercept\"\nlmer_stats[lmer_stats$term== \".$sev\",c(\"parameters\")] <- \"Slope\"\n\ni <- 1\n while (i <= nrow(lmer_stats)) {\n  if (lmer_stats$parameters[i] == \"Slope\" && lmer_stats$estimate[i] > 0) {\n    # Remove a linha do Slope e a linha do Intercept correspondente\n    lmer_stats <- lmer_stats[-c(i, i - 1), ]\n    # Atualiza o índice, pois duas linhas foram removidas\n    i <- i - 2\n  }\n  i <- i + 1\n }\nlmer_stats\n\n\nslope_trial_m= lmer_stats |> \n  filter(parameters == \"Slope\") %>% \n  summarise(\n    Slope = estimate\n  )\n\nslope_trial_m[,1] = NULL\n\nslope_trial_m |> \n  filter(!Slope == \"NA\") |> \n  summarise(\nmean = mean(Slope))\n\nintercept_trial_m = lmer_stats |> \n  filter(parameters == \"Intercept\") %>%  \n  summarise(\n    Intercept = estimate\n  )\nintercept_trial_m[,1] = NULL\n\nmean(intercept_trial_m$Intercept)\n\nregression_trial_m = cbind(slope_trial_m,intercept_trial_m)\nregression_trial_m[,3] = NULL\n\nsummary_stats <- regression_trial_m %>%\n  reframe(\n    mean_intercept = mean(Intercept),\n    mean_slope = mean(Slope),\n    ci_intercept_lower = quantile(Intercept, 0.025),\n    ci_intercept_upper = quantile(Intercept, 0.975),\n    ci_slope_lower = quantile(Slope, 0.025),\n    ci_slope_upper = quantile(Slope, 0.975)\n  )\n\nlmer_plot = simulated_data_lmer|> \n ggplot(aes(sev, y = yld)) +\n  geom_point(color = \"NA\")+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  geom_abline(data =regression_trial_m, aes(slope = Slope, intercept = Intercept), size = 1,\n              alpha = 0.5, color = \"grey\")+##9ccb86\n#  geom_abline(data =summary_stats, aes(slope = mean_slope, intercept = mean_intercept),\n #             size = 1.5, fill = \"black\", color = \"black\")+\n  geom_abline(data = summary_stats,aes(intercept = ci_intercept_lower,slope = ci_slope_lower) ,\n              size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(data = summary_stats, aes(intercept = ci_intercept_upper,slope = ci_slope_upper), size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline( aes(slope = -49.38, intercept = 9691.0),\n              size = 1.5, fill = \"black\", color = \"black\")+\n  geom_abline(aes(intercept = 9555.81,slope = -50.65) ,\n              size = .51, linetype = 2)+\n  geom_abline(aes(intercept = 9826.19,slope = -48.12), size = .51, linetype = 2)+\n   ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\", y = \"\",\n       title = \"\")\n\nlmer_plot\n```\n\n\n## Joining\n```{r}\n\nplot_grid(trials,lmer_plot,plot_sev, plot_yld, labels = c(\"(a)\",\"(b)\",\"(c)\",\"(d)\"), ncol = 2,\n          label_size = 10, label_x = -0.01)\n\n\nggsave(\"fig/obs_simu_model.png\", bg = \"white\", dpi = 600,width = 6, height = 4)\n\n```\n\n```{r}\ncor(estria2$mean_sev, estria2$mean_yld)\ncor(simulated_data_lmer$sev, simulated_data_lmer$yld)\n```\n\n# Performance\n\n### Empirical\n```{r}\n\nobs_lmer_predicted <- predict(obs_model_lmer)\n\n\nobs_lmer_observed <- estria2$mean_yld\n\n\nobs_lmer_residuals <- obs_lmer_observed - obs_lmer_predicted\n\n\nobs_lmer_RMSE <- sqrt(mean(obs_lmer_residuals^2))  \nobs_lmer_MAE <- mean(abs(obs_lmer_residuals))     \nobs_lmer_correlation <- cor(obs_lmer_observed, obs_lmer_predicted)\n\nperformance::check_normality(obs_model_lmer)\nperformance::check_heteroscedasticity(obs_model_lmer)\nperformance::check_autocorrelation(obs_model_lmer)\n\n```\n### Simulated\n```{r}\n\nsimu_lmer_predicted <- predict(simu_model_lmer)\n\n\nsimu_lmer_observed <- simulated_data_lmer$yld\n\n\nsimu_lmer_residuals <- simu_lmer_observed - simu_lmer_predicted\n\n\nsimu_lmer_RMSE <- sqrt(mean(simu_lmer_residuals^2))  \nsimu_lmer_MAE <- mean(abs(simu_lmer_residuals))     \nsimu_lmer_correlation <- cor(simu_lmer_observed, simu_lmer_predicted)       \n\nperformance::check_normality(simu_model_lmer)\nperformance::check_heteroscedasticity(simu_model_lmer)\nperformance::check_autocorrelation(simu_model_lmer)\n```\n\n\n## Visualization\n\n#### Simulated\n\n```{r}\n\n# Extrair os resíduos e quantis teóricos\nlmer_residuals <- residuals(simu_model_lmer, type = \"deviance\")\nlmer_qq_data <- data.frame(\n  theoretical = qqnorm(lmer_residuals, plot.it = FALSE)$x*1000,\n  residuals = qqnorm(lmer_residuals, plot.it = FALSE)$y\n)\n\n# Plotar o QQ plot\nlmer_qq = lmer_qq_data %>% \n  ggplot(aes(x = theoretical, y = residuals)) +\n  geom_point() +\n  geom_abline(intercept = 0, slope = 1, color = \"red\", linetype = \"dashed\") +\n  scale_x_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Theoretical Quantiles\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlmer_qq\n```\n\n```{r}\n# Extrair preditores lineares e resíduos\nlmer_linear_predictors <- predict(simu_model_lmer, type = \"link\")\nlmer_residuals_data <- data.frame(\n  linear_predictors = lmer_linear_predictors,\n  residuals = lmer_residuals\n)\n\n# Plotar resíduos vs preditores lineares\nlmer_predictors = lmer_residuals_data %>% \n  ggplot(aes(x = linear_predictors, y = residuals)) +\n  geom_point(alpha = 0.2, color = \"grey\", size = 2) +\n  geom_hline(yintercept = 0, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Linear Predictors\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n```\n\n```{r}\n\n# Calcular média e desvio-padrão dos resíduos\nmean_res <- mean(lmer_residuals_data$residuals)\nsd_res <- sd(lmer_residuals_data$residuals)\n\n# Plotar o histograma e a curva acumulada normal\nlmer_res_hist <- ggplot(lmer_residuals_data, aes(x = residuals)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_res, sd = sd_res), \n                color = \"darkred\", size = 1.2, linetype = \"solid\") + # Adiciona a curva normal\n  scale_x_continuous(breaks = c(-2500, -1250, 0, 1250, 2500), \n                     limits = c(-2500, 2500)) +\n  labs(x = \"Deviance Residuals\", y = \"\") +\n  ggthemes::theme_few() +\n  theme(text = element_text(size = 12, face = \"bold\"))\n\n# Exibir o gráfico\nlmer_res_hist\n\n\n```\n\n```{r}\n# Extrair valores observados e preditos\nlmer_observed <- simulated_data_lmer$yld\nlmer_predicted <- predict(simu_model_lmer, type = \"response\")\nlmer_prediction_data <- data.frame(\n  observed = lmer_observed,\n  predicted = lmer_predicted\n)\n\n# Plotar valores preditos vs observados\nlmer_pd_ob = lmer_prediction_data %>% \n  ggplot(aes(x = observed, y = predicted)) +\n  geom_point(alpha = 0.5, color = \"grey\", size = 2) +\n  geom_abline(intercept = 0, slope = 1, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  labs(x = \"Observed\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlmer_pd_ob\nmax(lmer_prediction_data$predicted)\n```\n#### Observed\n\n```{r}\n\n# Extrair os resíduos e quantis teóricos\nobs_lmer_residuals <- residuals(obs_model_lmer, type = \"deviance\")\nobs_lmer_qq_data <- data.frame(\n  theoretical = qqnorm(obs_lmer_residuals, plot.it = FALSE)$x*1000,\n  residuals = qqnorm(obs_lmer_residuals, plot.it = FALSE)$y\n)\n\n# Plotar o QQ plot\nobs_lmer_qq = obs_lmer_qq_data %>% \n  filter(!residuals < -2000) %>% \n  ggplot(aes(x = theoretical, y = residuals)) +\n  geom_point() +\n  geom_abline(intercept = 0, slope = 1, color = \"red\", linetype = \"dashed\") +\n   scale_x_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Theoretical Quantiles\", y = \"Dev. Residuals\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nobs_lmer_qq\n```\n\n```{r}\n# Extrair preditores lineares e resíduos\nobs_lmer_linear_predictors <- predict(obs_model_lmer, type = \"link\")\nobs_lmer_residuals_data <- data.frame(\n  linear_predictors = obs_lmer_linear_predictors,\n  residuals = obs_lmer_residuals\n)\n\n# Plotar resíduos vs preditores lineares\nobs_lmer_predictors = obs_lmer_residuals_data %>%\n  filter(!residuals < -2000) %>% \n  ggplot(aes(x = linear_predictors, y = residuals)) +\n  geom_point(alpha = 0.2, color = \"grey\", size = 2) +\n  geom_hline(yintercept = 0, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Linear Predictors\", y = \"Dev. Residuals\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n```\n\n```{r}\n# Calcular média e desvio-padrão dos resíduos\nmean_res <- mean(obs_lmer_residuals_data$residuals)\nsd_res <- sd(obs_lmer_residuals_data$residuals)\n\n# Plotar o histograma e a curva acumulada normal\nobs_lmer_res_hist <- ggplot(obs_lmer_residuals_data, aes(x = residuals)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_res, sd = sd_res), \n                color = \"darkred\", size = 1.2, linetype = \"solid\") + # Adiciona a curva normal\n  scale_x_continuous(breaks = c(-2500, -1250, 0, 1250, 2500), \n                     limits = c(-2500, 2500)) +\n  labs(x = \"Deviance Residuals\", y = \"Frequency\") +\n  ggthemes::theme_few() +\n  theme(text = element_text(size = 12, face = \"bold\"))\n\n# Exibir o gráfico\nobs_lmer_res_hist\n\n```\n\n```{r}\n# Extrair valores observados e preditos\nobs_lmer_observed <- estria2$mean_yld\nobs_lmer_predicted <- predict(obs_model_lmer, type = \"response\")\nobs_lmer_prediction_data <- data.frame(\n  observed = obs_lmer_observed,\n  predicted = obs_lmer_predicted\n)\n\n# Plotar valores preditos vs observados\nobs_lmer_pd_ob = obs_lmer_prediction_data %>% \n  ggplot(aes(x = observed, y = predicted)) +\n  geom_point(alpha = 0.5, color = \"grey\", size = 2) +\n  geom_abline(intercept = 0, slope = 1, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  labs(x = \"Observed\", y = \"Predicted\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nobs_lmer_pd_ob\n```\n\n#### Plotting\n```{r}\n#plot_grid(obs_lmer_pd_ob,lmer_pd_ob,\n #         obs_lmer_qq,lmer_qq,\n  #        obs_lmer_predictors,lmer_predictors,\n   #       obs_lmer_res_hist,lmer_res_hist, ncol = 2, labels = c(\"a\"),\n    #      label_x = -0.01,label_y = 0.01)\n\n(obs_lmer_pd_ob | lmer_pd_ob) / \n(obs_lmer_qq | lmer_qq) / \n(obs_lmer_predictors | lmer_predictors) / \n(obs_lmer_res_hist | lmer_res_hist) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\") &\n  theme(plot.tag = element_text(face = \"bold\", size = 14))\n\n\nggsave(\"fig/lmm_residue.png\", dpi = 600, bg = \"white\", height = 6, width = 8)\n```\n\n# Power analysis of model by simulation\n### Severity\n\n\n```{r,eval = FALSE, echo = TRUE}\nlibrary(simr)\nlibrary(ggplot2)\nlibrary(dplyr)\n\n# Ajuste do modelo original\nsev_lmer <- lmer(mean_yld ~ mean_sev + (1 | trial), data = estria2)\n\n# Criar um modelo extendido para simulação\next_sev_lmer <- extend(sev_lmer, along = \"mean_sev\", n = 10000)\n\n# Rodar várias simulações do powerCurve e armazenar os resultados\nnum_simulations <- 50  # Número de simulações individuais\npower_results <- list()\n\nfor (i in 1:num_simulations) {\n  power_results[[i]] <- as.data.frame(summary(powerCurve(ext_sev_lmer, \n                                                          along = \"mean_sev\", \n                                                          nsim = 100, \n                                                          breaks = 1:100)))\n}\n\n\npower_df <- bind_rows(power_results, .id = \"simulation\")\n\n#write_xlsx(power_df, \"data/power_df.xlsx\")\n\n\n\n```\n\n```{r}\npower_df = read_xlsx(\"data/power_df.xlsx\")\n\n\npower_df2 <- power_df %>%\n  group_by(nlevels) %>%\n  summarise(mean = mean(mean, na.rm = TRUE),\n            lower = mean(lower, na.rm = TRUE),\n            upper = mean(upper, na.rm = TRUE))\n\npower_df %>% \n  filter(mean >= 0.80 & mean <=0.85)\n```\n\n#### Plotting\n\n```{r}\nggplot() +\n  # Linhas cinzas para cada simulação individual\n  geom_line(data = power_df, aes(x = nlevels, y = mean * 100, group = simulation), \n            color = \"gray\", alpha = 0.4) +\n  # Linha da média (laranja)\n  geom_line(data = power_df2, aes(x = nlevels, y = mean * 100), \n            color = \"black\", size = 1.2) +\n  # Linhas superior e inferior (preto, tracejado)\n  geom_line(data = power_df2, aes(x = nlevels, y = upper * 100), \n            color = \"black\", linetype = \"dashed\", size = 0.8) +\n  geom_line(data = power_df2, aes(x = nlevels, y = lower * 100), \n            color = \"black\", linetype = \"dashed\", size = 0.8)+\n  scale_x_continuous(breaks = c(0,5,10,15,20,25,30,35,40,45,50), limits = c(0, 50))+\n  scale_y_continuous(breaks = c(0,10,20,30,40,50,\n                                60,70,80,90,100), limits = c(0, 100))+\n  geom_hline(yintercept = 80, linetype = \"dashed\", size = 1, color = \"darkblue\")+\n  geom_vline(xintercept = c(25), linetype = 2, size = 1, color = \"darkblue\")+\n  coord_cartesian(xlim = c(0,50))+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\",\n       y = \"Power (%)\")\n\nggsave(\"fig/power_model.png\", bg = \"white\", dpi = 600,width = 6, height = 4)\n```\n\n\n# Damage\n\n## Economic losses\n\n```{r}\n\n\nsev  = data.frame(sev = seq(20,100, by = 10))\nyield = data.frame(yld = seq(4000,12000,by = 500))\nprice = data.frame(price = seq(100,300, by = 100))\n\ncombined_data <- expand.grid(sev = sev$sev, yld = yield$yld, price = price$price)\n\nylmer_simu_min = combined_data %>% \n  mutate(loss =((((((49.3/9691.0)*sev)*100)*yld)/100)/1000)*price)\n\n\ncustom_labels <- c(\n  \"100\" = \"100 USD/ton\",\n  \"200\" = \"200 USD/ton\",\n  \"300\" = \"300 USD/ton\"\n)\n\n\n heat_loss =ylmer_simu_min %>%\n   filter(price == \"200\") %>% \n  ggplot(aes(sev,yld, fill = loss)) +\n  geom_tile(color = \"white\", size = 0.8) +\n  scale_x_continuous(breaks = seq(20, 100, by = 10)) +\n  scale_y_continuous(breaks = seq(4000, 12000, by = 500)) +\n  scale_fill_viridis_b(option = \"E\", \n                     guide = guide_colorbar(barwidth = 0.3, barheight = 15), \n                     breaks = seq(0, 2000, by = 300))+\n   geom_text(aes(label = as.integer(loss)),\n    size = 3, colour = \"white\")+\n   #facet_wrap(~price, labeller = as_labeller(custom_labels))+\n  theme_minimal_grid(font_size = 14) +\n  labs(\n    y = \"Attainable yield (kg/ha)\",\n    x = \"Disease severity (%)\",\n    fill = \"L (USD/ha)\"\n  )+\n   theme(text = element_text(size = 14),\n     axis.title = element_text(size = 20, face = \"bold\"),\n    strip.text = element_text(size= 14, vjust = -1),\n    #axis.text.y = element_text(hjust = -3),\n    axis.text.x = element_text(vjust = 3),\n    legend.position = \"right\",\n    legend.justification = 0.5,\n    panel.grid = element_blank())\n\nhist_loss = ylmer_simu_min |>\n  filter(price == \"200\") %>% \n  ggplot(aes(loss))+\n  geom_histogram(color = \"white\", fill= \"#1c1c3c\", bins = 15)+\n  facet_wrap(~price)+\n  ggthemes::theme_few() +\n   scale_x_continuous(breaks = seq(0,2100, by = 300)) +\n  labs(\n    y = \"Frequency\",\n    x = \"Economic losses (USD/ha)\")+\n    theme(\n    text = element_text(face = \"bold\", size = 14),\n    axis.title = element_text(size = 20, face = \"bold\"),\n    axis.text.x = element_text(vjust = 1, size = 14, face = \"bold\"),\n    axis.text.y = element_text(vjust = 1, size = 14, face = \"bold\"),\n    legend.position = \"none\",\n    legend.justification = 0.5,\n    panel.grid = element_blank(),\n    strip.text = element_blank() \n  )\n\nloss_200 = ylmer_simu_min |>\n  filter(price == \"200\") \n\nmedian(loss_200$loss)\n\nhist_loss = ylmer_simu_min %>% \n  filter(price == \"200\") %>%\nggplot(aes(x = loss)) +\n  stat_halfeye(fill = \"#ffc425\", alpha = 0.7)+\n  geom_vline(aes(xintercept = 447.6731), color = \"#1c1c3c\", linetype = \"dashed\", size = 2) +\n  ggthemes::theme_few() +\n   #scale_x_continuous(breaks = seq(0,2100, by = 100)) +\n  scale_x_continuous(breaks=c(50,150,250,350,450,550,\n                              650,750,850,950,1050,\n                              1150,1250,1350,1450,1550,1650,1750,1850,1950,\n                              2150))+\n  labs(\n    y = \"Density\",\n    x = \"Economic losses (USD/ha)\")+\n    theme(\n    text = element_text(face = \"bold\", size = 14),\n    axis.title = element_text(size = 20, face = \"bold\"),\n    axis.text.x = element_text(vjust = 1, size = 14, face = \"bold\"),\n    axis.text.y = element_text(vjust = 1, size = 14, face = \"bold\"),\n    legend.position = \"none\",\n    legend.justification = 0.5,\n    panel.grid = element_blank(),\n    strip.text = element_blank() \n  )\n```\n\n```{r}\n\n# Below 25%\n\nsev_loss_b25  = data.frame(sev = seq(5,25, by = 5))\n\ncombined_data_b25 <- expand.grid(sev = sev_loss_b25$sev, yld = yield$yld)\n\nloss_25 = ((((((49.3/9691.0)*25)*combined_data_b25$sev)*combined_data_b25$yld)/100)/1000)*200\n\nmean(loss_25)\nmin(loss_25)\nmax(loss_25)\n\n# Above 25%\n\nsev_loss_a25  = data.frame(sev = seq(25,100, by = 5))\n\ncombined_data_a25 <- expand.grid(sev = sev_loss_a25$sev, yld = yield$yld)\n\nloss_25 = ((((((49.3/9691.0)*combined_data_a25$sev)*combined_data_a25$sev)*combined_data_a25$yld)/100)/1000)*200\n\nmean(loss_25)\nmin(loss_25)\nmax(loss_25)\n```\n\n```{r}\n\n(hist_loss+heat_loss) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 24)) \n\n ggsave(\"fig/loss.png\", bg = \"white\",\n       dpi = 600,height =8, width = 16)\n```\n\n## Relative yield\n\n```{r}\n\nlmer_slope= lmer_stats %>% \n  filter(parameters == \"Slope\")\n\nlibrary(minpack.lm)\nFx =environment(ecdf(-lmer_slope$estimate))$y\nx = environment(ecdf(-lmer_slope$estimate))$x\n\nslope_reg = nlsLM(Fx ~ pgamma(x, shape, rate,log = FALSE) ,\n      start = c(shape = 2.5, rate = 0.13),\n      control = nls.lm.control(maxiter = 1024))\nsummary(slope_reg)\n\n\nshape_res = summary(slope_reg)$coef[1]\nrate_res = summary(slope_reg)$coef[2]\nks.test(Fx, pgamma(x, shape_res, rate_res))\n\n\nslope_plot = lmer_slope %>% \n  ggplot(aes(x = estimate)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun=function(x) dgamma(-x, shape_res, rate_res), size = 1.2, color = \"darkblue\")+\n  ggthemes::theme_few()+\n  #facet_wrap(~approach)+\n  labs(x = \"Slope (kg/p.p)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"))\n\n\n\n\nlmer_intercept= lmer_stats %>% \n  filter(parameters == \"Intercept\")\n\nshapiro.test(lmer_slope$estimate)\n\nmean_intercept = mean(lmer_intercept$estimate)\nsd_intercept = sd(lmer_intercept$estimate)\n\nintercept_plot <- lmer_intercept %>% \n  ggplot(aes(x = estimate)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_intercept, sd = sd_intercept), \n                color = \"darkblue\", size = 1.2, linetype = \"solid\")+\n  ggthemes::theme_few()+\n  #facet_wrap(~approach)+\n  labs(x = \"Intercept (kg/ha)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"))\n\n\n```\n\n```{r}\n\nset.seed(1)\n\nu_j <- rnorm(100, mean = 0, sd = random_effect_sd)\n\n#mean_uj = mean(u_j)\n\ndf <- expand.grid(sev = seq(0, 100, by = 1), rep = 1:100)\ndf$yield = 9691.0 - 49.38*df$sev - rep(u_j, each = 101)\ndf$relative <- df$yield *100 / 9691.0\n\ndf2 = df %>% \n  group_by(sev) %>% \n  summarise(mean = mean(relative),\n     up_95 = quantile(relative, 0.975),\n     low_95 = quantile(relative, 0.025))\n\n\n\nrelative_plot = ggplot() +\n  geom_line(data = df, aes(x = sev, y = relative, group = rep), \n            color = \"grey\", alpha = 0.4) +  # Linhas cinzas para cada simulação\n  geom_line(data = df2, aes(x = sev, y = mean), \n            color = \"black\", size = 1.4) +  # Linha média\n  geom_line(data = df2, aes(x = sev, y = up_95), \n            color = \"black\", linetype = \"dashed\",size = 1) +  # IC superior\n  geom_line(data = df2, aes(x = sev, y = low_95), \n            color = \"black\", linetype = \"dashed\",size = 1) +  # IC inferior\n  scale_y_continuous(breaks = c(20,30, 40,50, 60,\n                                70,80,90,100), \n                     limits = c(20, 100),\n                     expand = c(0, 2))+\n  scale_x_continuous(breaks = c(0,10,20,30,40,50,60,70,80,90, 100),\n                     limits = c(0, 100),\n                     expand = c(0, 2))+\n  coord_cartesian(xlim = c(0,100), ylim = c(20,100))+\n  labs(x = \"Disease severity (%)\", y = \"Relative yield (%) \")+\n  geom_hline(yintercept = 87,\n             linetype = 2, color = \"darkblue\", size = 1)+\n  geom_vline(xintercept = c(25), linetype = 2, color = \"darkblue\", size = 1)+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.text.x = element_text(size = 10, face = \"bold\"),   \n        axis.text.y = element_text(size = 10, face = \"bold\"))\n```\n\n```{r}\n\nlibrary(patchwork)\n\n#plot_grid(slope_plot / intercept_plot | relative_plot, ncol = 1,\n #         label_x = -0.02, label_size = 12)\n\n(slope_plot / intercept_plot |relative_plot) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 12))\n\nggsave(\"fig/relative_parameters.png\", bg = \"white\", dpi = 600,\n       height = 4, width = 6)\n\n\n```\n\n# Break-even probability\n\n## Framework simulation\n\n### NORTA function\n```{r}\ngera.norm.bid.geral<-function(tamanho.amostra,correlacao,m1,m2,sigma1,sigma2)\n{\n  ro<-correlacao\n  n<-tamanho.amostra\n  x<-matrix(0,n,2)\n  for (i in 1:n)\n  {x[i,1]<-rnorm(1,m1,sigma1)\n  x[i,2]<-rnorm(1,m2+ro*sigma1/sigma2*(x[i,1]-m1),sigma2*(sqrt(1-ro^2)))\n  }\n  return(x)\n}\n\ngc()\n```\n```{r}\nestria2 %>% \n  ggplot(aes(mean_sev))+\n  geom_histogram(color= \"white\", fill = \"black\")+\n  ggthemes::theme_few()\n```\n### Severity\n```{r}\n\nlibrary(minpack.lm)\n  \nsev = simulated_data_lmer$sev\n#sev = estria2$mean_sev\nFx_sev = environment(ecdf(sev))$y\nx_sev = environment(ecdf(sev))$x/100\n\nsummary(nlsLM(Fx_sev ~ pbeta(x_sev, shape1, shape2, log = FALSE) ,\n      start = c(shape1 = 1, shape2 = 1),\n      control = nls.lm.control(maxiter = 100000)))\n```\n\n```{r}\nks.test(Fx_sev,pbeta(x_sev,1.2041125,3.6414300))\n```\n```{r}\nplot(x_sev,Fx_sev)\ncurve(pbeta(x, 1.2041125,3.6414300),0,1, add = T)\n```\n### Intercept\n```{r}\n\nintercept_bls = regression_trial_m\nintercept_bls[,1] = NULL\n\nmean_intercept = mean(intercept_bls$Intercept)\nsd_intercept = sd(intercept_bls$Intercept)\n\nplot(ecdf(intercept_bls$Intercept))\ncurve(pnorm(x, mean_intercept,sd_intercept), add = T, col = \"red\")\n\n\n```\n```{r}\nFx_res_b0 = environment(ecdf(intercept_bls$Intercept))$y\nx_res_b0= environment(ecdf(intercept_bls$Intercept))$x\nks.test(Fx_res_b0, pnorm(x_res_b0, mean(intercept_bls$Intercept), sd(intercept_bls$Intercept)))\n```\n\n### Slope\n```{r}\nslope_bls = regression_trial_m\nslope_bls[,2] = NULL\n  \n\nmean_slope = mean(slope_bls$Slope)\nsd_slope = sd(slope_bls$Slope)\n\nplot(ecdf(slope_bls$Slope))\ncurve(pnorm(x, mean_slope, sd_slope), add = T, col = \"red\")\n```\n```{r}\nlibrary(minpack.lm)\nFx =environment(ecdf(-slope_bls$Slope))$y\nx = environment(ecdf(-slope_bls$Slope))$x\n\nslope_reg = nlsLM(Fx ~ pgamma(x, shape, rate,log = FALSE) ,\n      start = c(shape = 2.5, rate = 0.13),\n      control = nls.lm.control(maxiter = 1024))\nsummary(slope_reg)\n```\n```{r}\nshape = summary(slope_reg)$coef[1]\nrate = summary(slope_reg)$coef[2]\n\nFx =environment(ecdf(-slope_bls$Slope))$y\nx = environment(ecdf(-slope_bls$Slope))$x\nks.test(Fx, pgamma(x, shape, rate))\n```\n\n```{r}\ncor(regression_trial_m$Slope,regression_trial_m$Intercept)\n```\n```{r}\nj_res<-gera.norm.bid.geral(10000,0.15,0,0,1,1)\n\nplot(j_res[,1],j_res[,2])\n```\n### Corn price\n\n```{r}\ncorn = gsheet2tbl(\"https://docs.google.com/spreadsheets/d/1LcLVKb6bW7tVaiu6reLsT8sjFR1hwUcembZ7uxAoBP8/edit?usp=sharing\") \n\ncorn = corn %>%\n  filter(state %in% c(\"PR\")) %>% \n  filter(year <= 2019)\n\n```\n\n```{r}\nbls_price = corn %>%\n  #filter(year <= 2019) %>%\n  mutate(price = (price/60)/4)\nbls_price\n\nmin(bls_price$price)\nmean(bls_price$price)\n```\n\n```{r}\nmean(bls_price$price)\nmedian(bls_price$price)\nsd(bls_price$price)\n```\n\n\n```{r}\nbls_price %>% \n  ggplot(aes(price))+\n  geom_histogram(fill = \"steelblue\", color = \"white\", bins = 10)+\n ggthemes::theme_few()+\n  labs(x = \"Soybean prince\",\n       y = \"Frequency\")+\n  scale_x_continuous(breaks = seq(0,1,by=0.025))+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        axis.title = element_text(size = 14, face = \"bold\"),\n        legend.position = \"none\")\n\n```\n\n```{r}\nhist((bls_price$price), prob = T)\ncurve(dnorm(x, mean(bls_price$price), sd(bls_price$price)),0.15,0.35, add = T)\n```\n\n```{r}\nplot(ecdf(bls_price$price))\ncurve(pnorm(x, mean(bls_price$price), sd(bls_price$price)),0.2,0.35, add = T)\n```\n\n```{r}\nmean(bls_price$price)\nmedian(bls_price$price)\n```\n\n```{r}\nshapiro.test(bls_price$price)\n```\n\n#### Kolmogorov-Smirnov Test\n\n```{r}\nFx = environment(ecdf(bls_price$price))$y\nx= environment(ecdf(bls_price$price))$x\nks.test(Fx, pnorm(x, mean(bls_price$price), sd(bls_price$price)))\n```\n\n```{r}\nplot(Fx, pnorm(x, mean(bls_price$price), sd(bls_price$price)))\n```\n\n#### Vizualization\n\n```{r}\nprice_plot = bls_price %>% \n  ggplot(aes(price))+\n geom_histogram(aes(y = ..density..),bins = 10, color = \"white\", fill = \"black\")+ #\"#1C8C20\"\n   #stat_function(fun=function(x) dnorm(x, mean(sbr_price$price), sd(sbr_price$price)), color= \"black\", size = 1.2)+\n  ggthemes::theme_few()+\n  labs(x=\"Soybean price (USD/kg)\", y = \"Frequency\")+\n  scale_x_continuous(breaks = seq(0,1,by=0.025))+\ntheme(text = element_text(size = 12, face = \"bold\"),\n        axis.title = element_text(size = 14, face = \"bold\"),\n        legend.position = \"none\")\nprice_plot\n\n  ggsave(\"fig/soybean_price.png\", bg = \"white\",\n       dpi = 600, height = 5, width = 6)\n```\n\n## Simulation\n\n```{r,eval = FALSE, echo = TRUE}\nset.seed(1)\nn=40000\nlambda = seq(0,1, by=0.05)\nfun_price = seq(-10, 260, by=15)\nn_aplication = 1\noperational_cost = 10  \n\ncomb_matrix = as.matrix(data.table::CJ(lambda,fun_price))\ncolnames(comb_matrix) = c(\"lambda\",\"fun_price\")\ncomb_matrix = cbind(comb_matrix,operational_cost, n_aplication)\nC = comb_matrix[,\"n_aplication\"]*(comb_matrix[,\"operational_cost\"]+comb_matrix[,\"fun_price\"] )\ncomb_matrix = cbind(comb_matrix,C)\n\nN = length(comb_matrix[,1])*n\nbig_one = matrix(0, ncol = 12, nrow =N)\nbig_one[,1] = rep(comb_matrix[,1],n)\nbig_one[,2] = rep(comb_matrix[,2],n)\nbig_one[,3] = rep(comb_matrix[,3],n)\nbig_one[,4] = rep(comb_matrix[,4],n)\nbig_one[,5] = rep(comb_matrix[,5],n)\n\nset.seed(1)\n\n\nsn = rbeta(N, 1.2041125,3.6414300)\nsf = sn*(1-big_one[,1])\n\n# simulating the coeficientes \n\n\nset.seed(1)\nnormal_correlated<-gera.norm.bid.geral(N,0.15,0,0,1,1)\nb0_n = pnorm(normal_correlated[,2])\nb1_n = pnorm(normal_correlated[,1])\nb0 = qnorm(b0_n, mean_intercept,sd_intercept)\nb1 = -qgamma(b1_n, shape, rate,)\nrm(b0_n,b1_n,normal_correlated)\n\n\n# Calculating the alha coeficient\n\n\nalfa = (b1/b0)*100\n\n# Calculating yield gain\n\n## Moderate Resistant (MR)\n\nyn  = b0 - (-alfa*b0*sn)\nyf  = b0 - (-alfa*b0*sf)\n\n\n# Simulating soybean price\n\nset.seed(1)\nsoy_price = rnorm(N, mean(bls_price$price),sd(bls_price$price))\n\n#income = yield_gain*soy_price # calculating the income\n\nbig_one[,6] = yn\nbig_one[,7] = yf\nbig_one[,8] = b1\nbig_one[,9] = b0\nbig_one[,10] = sn\nbig_one[,11] = sf\nbig_one[,12] = soy_price\ncolnames(big_one)  = c(\"lambda\",\"fun_price\",\"operational_cost\",\"n_aplication\",\"C\",\"yn\",\"yf\",\n                       \"b1\",\"b0\",\"sn\",\"sf\",\"soy_price\")\n```\n\n```{r,eval = FALSE, echo = TRUE}\nbig_one_df = as.data.frame(big_one) %>% \n  filter(b0>=0) %>% \n  filter(yn>0) %>% \n  filter(alfa > -3 & alfa < 0) %>%\n  mutate(yield_gain = yf-yn,\n         yield_gain_perc = ((yf/yn)-1)*100,\n         income = yield_gain*soy_price,#0.2\n         CP = C/soy_price,#0.2\n         profit = (income>=C)*1) %>% \n        filter(C <= 180) %>%\n        filter(lambda >= 0.4) %>%\n        filter(lambda <= 0.8)\n\ngc()\n```\n\n```{r}\n#write_csv(big_one_df,\"data/big_one_df.csv\")\nbig_one_df = read_csv(\"data/big_one_df.csv\")\n```\n\n```{r}\nsn = big_one_df %>% \n  ggplot(aes(sn))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n  theme(text = element_text(face = \"bold\", size = 14),\n        axis.title = element_text(face = \"bold\",size = 16))+\n  labs(y = \"Frequency\",\n       x = \"BLS severity (%)\")+\n  ggthemes::theme_few()\n\ngc()\n\n```\n\n```{r}\nb0_graphic = big_one_df %>% \n  ggplot(aes(b0))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n   #scale_x_continuous(breaks = c(0,1000,2000,3000,4000,5000,6000,7000), limits = c(0, 7000))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Intercept (kg/ha)\")+\n  ggthemes::theme_few()\n\ngc()\n```\n```{r}\nb1_graphic = big_one_df %>% \n  ggplot(aes(b1))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n  #scale_x_continuous(breaks = c(-100,-90,-80,-70,-60,-50,-40,-30,-20,-10,0), limits = c(-100,0))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Slope (kg/p.p.)\")+\n  ggthemes::theme_few()\n\ngc()\n\nb1_graphic\n```\n```{r,eval = FALSE, echo = TRUE}\nalpha_graphic = big_one_df %>% \n    filter(C <= 180) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 60) %>%\n  ggplot(aes(alfa))+\n  geom_histogram(color = \"white\", fill = \"black\", bins = 10)+\n  #scale_x_continuous(breaks = c(-2.0,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,0.0), limits = c(-2.0,0.0))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Yield loss (%/p.p.)\")+\n  ggthemes::theme_few()\n\ngc()\n\nalpha_graphic\n\n```\n\n```{r,eval = FALSE, echo = TRUE}\n#alpha_res_graphic,alpha_m_sus_graphic,alpha_sus_graphic,\nplot_grid(sn_res_graphic,b0_res_graphic,b1_res_graphic, ncol = 3,  labels = c(\"(a)\", \"(b)\", \"(c)\"),label_x = -0.03)\n\nggsave(\"fig/simulated_variables.png\", dpi = 1000, bg = \"white\",\n       height = 8, width = 12)\n```\n\n```{r}\n\nheat <- big_one_df %>%\n  filter(C <= 180) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 15) %>%\n  group_by(lambda, C) %>%\n  summarise(n = n(), sumn = sum(profit), prob = sumn / n) \n\ngc()\n```\n```{r}\nheat_graphic = heat %>% \n  ggplot(aes(as.factor(lambda * 100), as.factor(C), fill = prob)) +\n  geom_tile(size = 0.5, color = \"white\") +\n  scale_fill_viridis_b(option = \"D\", direction = -1) +\n  scale_color_manual(values = c(\"#E60E00\", \"#55E344\")) +\n  guides(color = guide_legend(override.aes = list(size = 2))) +\n  labs(x = \"Fungicide efficacy (%)\",\n       y = \"Fungicide + Application cost ($)\",\n       fill = \"Pr(I \\u2265 C)\",\n       color = \"\") +\n # facet_wrap(vars(class, class2)) +\n  ggthemes::theme_few()+\n  theme(strip.text = element_text(face = \"bold\", size = 14),\n        text = element_text(face = \"bold\", size = 14))\n\n\ngc()\n```\n\n```{r}\nbig = big_one_df %>%\n   mutate(class = case_when(sn > 0.25 ~ \"High severity\",\n                           sn <= 0.25 ~\"Low severity\"))\n```\n\n```{r}\n\nclass <- big %>%\n  filter(C <= 105) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 15) %>%\n  group_by(lambda, C, class) %>%\n  summarise(n = n(), sumn = sum(profit), prob = sumn / n, .groups = 'drop') %>%\n  ungroup()  \n\ngc()\n```\n```{r}\nlibrary(viridis)\nheat_graphic = class %>% \n  filter(!is.na(class)) %>% \n  ggplot( aes(as.factor(lambda * 100), as.factor(C), fill = prob)) +\n  geom_tile(size = 0.5, color = \"white\") +\n  #geom_text(aes(label = paste(round(prob, 2), sep = \"\")),\n   # size = 4, colour = \"white\")+\n  scale_fill_viridis_b(option = \"E\", direction =  -1)+\n  #scale_fill_viridis(discrete = T, option = \"E\") +\n  guides(color = guide_legend(override.aes = list(size = 2))) +\n  labs(x = \"Treatment efficacy (%)\",\n       y = \"Treatment cost (USD/ha)\",\n       fill = \"Pr(I \\u2265 C)\",\n       color = \"\") +\n  facet_wrap(vars(class), ncol =1) +\n  ggthemes::theme_few()+\n  theme(strip.text = element_text(face = \"bold\", size = 14),\n        text = element_text(face = \"bold\", size = 14),\n        legend.position = \"right\")\n\ngc()\n```\n\n\n```{r}\nlow_class = class %>% \n  filter(class == \"Low severity\")\n\nmin(low_class$prob)\nmax(low_class$prob)\nmean(low_class$prob)\n\nlow_class %>% \n  filter(C <= 15)\n\nhigh_class = class %>% \n  filter(class == \"High severity\")\n\nmin(high_class$prob)\nmax(high_class$prob)\nmean(high_class$prob)\n\n\n```\n\n\n\n```{r}\noverall = big %>%\n  filter(C <= 105) %>%\n  filter(C >= 15) %>%\n  #mutate(sev_class = \" Overall\") %>% \n  dplyr::group_by(lambda,class) %>% \n  summarise(yield_gain_median = median(yield_gain),\n            yield_gain_mean = mean(yield_gain),\n            up_95 = quantile(yield_gain, 0.975),\n            low_95 = quantile(yield_gain, 0.025),\n            up_75 = quantile(yield_gain, 0.75),\n            low_75 = quantile(yield_gain, 0.25)) \n```\n```{r}\n\n\n gain_graphic = overall %>% \n  ggplot(aes(lambda*100,yield_gain_mean))+\n  geom_line(aes(lambda*100, low_95),\n              linetype = 2,\n            size = 1,\n            fill = NA, color = \"black\")+\n  geom_line(aes(lambda*100, up_95),\n              linetype = 2,\n            size = 1,\n          fill = NA,color = \"black\")+\n  geom_line(size = 1.4, aes(lambda*100,yield_gain_median), color = \"#ffc425\")+\n   #scale_y_continuous(breaks = c(0, 500, 1000, 1500,2000,\n    #                             2500, 3000), \n     #                 limits = c(0, 3000))+\n   #scale_x_continuous(breaks = c(40,50,60,70,80), limits = c(40, 80))+\n  #scale_color_viridis_d()+\n  #scale_color_manual(values = c('steelblue', '#9ccb86', 'darkred'))+\n  ggthemes::theme_few()+\n  facet_wrap(~class, ncol = 1)+\n  #facet_wrap(~class+class2)+\n  labs(x = \"Treatment efficacy (%)\",\n       y = \"Yield difference (kg/ha)\",\n       color = \"Tolerance level\", \n       linetype = \"\", fill = \"\")+\n  theme(text = element_text(face = \"bold\", size = 14),\n        strip.text = element_text(size = 14),\n        legend.position = \"top\")\n```\n```{r}\nlibrary(cowplot)\n\n(gain_graphic+heat_graphic) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 16))\n\nggsave(\"fig/break-even_gain.png\", dpi = 600, bg = \"white\",\n       width = 8, height = 6)\n```\n\n","srcMarkdownNoYaml":"\n\n# Packages\n\n```{r}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(gsheet)\nlibrary(lme4)\nlibrary(cowplot)\nlibrary(readxl)\nlibrary(writexl)\nlibrary(ggdist)\n```\n\n# Importation\n\n```{r}\ngls = gsheet2tbl(\"https://docs.google.com/spreadsheets/d/1TC_-I7OpUloaqh5sd3mVu8YW-V1Lxk8SZ_DRCIUmWOE/edit?usp=sharing\")\n\n```\n\n# Descriptive analysis\n\n## Severity\n\n```{r}\n\nplot_sev = gls %>% \n  ggplot(aes(sev))+\n  geom_histogram(color = \"white\", fill = \"black\")+\n  #stat_function(fun=function(x) dbeta(x, 0.94145, 6.45601), color= \"darkred\", size = 1.2)+\n  ggthemes::theme_few()+\n  labs(x = \"Disease severity (%)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"))\n\n```\n\n\n## Yield\n\n```{r}\nyy = gls %>% \n  filter(!yld <= 1500)\n\nmean(gls$yld)\nmax(gls$yld)\nmin(yy$yld)\n\nquantile(yy$yld)\n```\n\n\n```{r}\n\nmean_intercept = mean(gls$yld)\nsd_intercept = sd(gls$yld)\n\nplot_yld = gls %>% \n  filter(!yld <=1000) %>% \n  ggplot(aes(yld))+\ngeom_histogram(fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  scale_x_continuous(breaks = c(4000, 6000,8000,10000,12000, 14000), limits = c(4000, 14000))+\n  ggthemes::theme_few()+\n  labs(x = \"Yield (kg/ha)\",\n       y = \"\")+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"))\n\nplot_yld\n```\n\n```{r}\nplot_grid(plot_sev, plot_yld, ncol = 2, label_x = -0.03, label_size = 14,\n          labels = c(\"(a)\",\"(b)\"))\nggsave(\"fig/sev_yld.png\", bg = \"white\", dpi = 600, \n       width = 8, height = 4)\n\n```\n\n## Prepare data\n\n```{r}\nestria2 <- gls |> \n  group_by(trial, hybrid) |> \n  summarise(mean_sev = mean(sev),\n            mean_yld = mean(yld))\n\n\nmax(estria2$mean_sev)\nmin(estria2$mean_sev)\nmean(estria2$mean_sev)\nmedian(estria2$mean_sev)\nsd(estria2$mean_sev)\n\nmax(estria2$mean_yld)\nmin(estria2$mean_yld)\nmean(estria2$mean_yld)\nmedian(estria2$mean_yld)\nsd(estria2$mean_yld)\n```\n\n## Visualize\n\n```{r}\n\nestria2 = estria2 %>% \n  mutate(\n    period = case_when(trial == \"2018_1\"~ \"2018/1\",\n                       trial == \"2018_2\" ~\"2018/2\",\n                       trial == \"2018_19\"~\"2018/2019\",\n                       trial == \"2019_1\" ~\"2019/1\"))\nlibrary(ggthemes)\n\n trials = estria2 |>\n  ggplot(aes(mean_sev, mean_yld, group = as.factor(period),color = as.factor(period)))+ #\n  geom_point()+\n  #facet_wrap(~period)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2)+\n  scale_color_viridis_d()+\n  theme_minimal()+\n   scale_y_continuous(breaks = c(4000, 5000,6000,7000,8000,9000,10000,11000,12000), \n                     limits = c(4000, 12000))+\n  theme_few()+\n  labs(x = \"Disease severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Seasons\")+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        legend.position = \"none\")\n  #geom_abline(slope = -49.3, intercept = 9714, linetype = 1, linewidth =2, color = \"gray50\")\n\nggsave(\"fig/trials.png\", bg = \"white\", dpi = 600, \n       width = 6, height = 4)\n\n```\n\n```{r}\nlibrary(broom)\nlmer_stats = estria2 %>%\n  #group_by(year) %>%\n  dplyr::select(trial, mean_yld,mean_sev) %>%\n  group_by(trial) %>%\n  do({\n    model <- lm(.$mean_yld ~ .$mean_sev)\n    tidy_model <- tidy(model)\n    confint_model <- confint(model)  # Calcula os intervalos de confiança\n    bind_cols(tidy_model, confint_model)\n  })\n\n\n\n\nlmer_stats = lmer_stats |> \nfilter(term %in% c(\"(Intercept)\",\".$mean_sev\"))\n \nlmer_stats[lmer_stats$term== \"(Intercept)\",c(\"parameters\")] <- \"Intercept\"\nlmer_stats[lmer_stats$term== \".$mean_sev\",c(\"parameters\")] <- \"Slope\"\n\ni <- 1\n while (i <= nrow(lmer_stats)) {\n  if (lmer_stats$parameters[i] == \"Slope\" && lmer_stats$estimate[i] > 0) {\n    # Remove a linha do Slope e a linha do Intercept correspondente\n    lmer_stats <- lmer_stats[-c(i, i - 1), ]\n    # Atualiza o índice, pois duas linhas foram removidas\n    i <- i - 2\n  }\n  i <- i + 1\n }\nlmer_stats\n\n\nslope_trial_m= lmer_stats |> \n  filter(parameters == \"Slope\") %>% \n  summarise(\n    Slope = estimate\n  )\n\nslope_trial_m[,1] = NULL\n\nslope_trial_m |> \n  filter(!Slope == \"NA\") |> \n  summarise(\nmean = mean(Slope))\n\nintercept_trial_m = lmer_stats |> \n  filter(parameters == \"Intercept\") %>%  \n  summarise(\n    Intercept = estimate\n  )\nintercept_trial_m[,1] = NULL\n\nmean(intercept_trial_m$Intercept)\n\nregression_trial_m = cbind(slope_trial_m,intercept_trial_m)\nregression_trial_m[,3] = NULL\n\nsummary_stats <- regression_trial_m %>%\n  reframe(\n    mean_intercept = mean(Intercept),\n    mean_slope = mean(Slope),\n    ci_intercept_lower = quantile(Intercept, 0.025),\n    ci_intercept_upper = quantile(Intercept, 0.975),\n    ci_slope_lower = quantile(Slope, 0.025),\n    ci_slope_upper = quantile(Slope, 0.975)\n  )\n\ntrials = estria2|> \n ggplot(aes(mean_sev, y = mean_yld)) +\n  geom_point(color = \"NA\")+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  geom_abline(data =regression_trial_m, aes(slope = Slope, intercept = Intercept), size = 1,\n              alpha = 0.5, color = \"grey\")+##9ccb86\n  #geom_abline(data =summary_stats, aes(slope = mean_slope, intercept = mean_intercept),\n   #           size = 1.5, fill = \"black\", color = \"black\")+\ngeom_abline(data = summary_stats,aes(intercept = ci_intercept_lower,slope = ci_slope_lower) ,\n              size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(data = summary_stats, aes(intercept = ci_intercept_upper,slope = ci_slope_upper), size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(aes(slope = -49.37, intercept = 9714.0),\n              size = 1.5, fill = \"black\", color = \"black\")+\ngeom_abline(aes(intercept = 8699.1,slope = -60.59) ,\n              size = .51, linetype = 2)+\n  geom_abline(aes(intercept = 10733.8,slope = -38.00), size = .51, linetype = 2)+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\", y = \"Attainable yield (kg/ha)\",\n       title = \"\")\n```\n\n```{r}\nfirst_plot = estria2 |> \n  filter(trial == \"2018_1\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nsecond_plot = estria2 |> \n  filter(trial == \"2018_2\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nthird_plot = estria2 |> \n  filter(trial == \"2018_19\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nfourth_plot = estria2 |> \n  filter(trial == \"2019_1\") %>% \n  ggplot(aes(mean_sev, mean_yld))+ #, group = trial, color = trial\n  geom_point()+\n  facet_wrap(~trial)+\n  geom_smooth(method = \"lm\", se = FALSE, size = 2, color = \"black\")+\n  scale_x_continuous(breaks = c(0, 20, 40,60,80), limits = c(0, 80))+\n  scale_y_continuous(breaks = c(5000, 7500, 10000,12500), limits = c(5000, 12500))+\n  scale_color_viridis_d()+\n  theme_minimal()+\n  theme_few()+\n  labs(x = \"Severity (%)\",\n       y = \"Yield (kg/ha)\",\n       color = \"Trial\")+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlibrary(patchwork)\n\ncombined_plot <- (first_plot | plot_yld | second_plot) / \n                 (third_plot | plot_sev | fourth_plot) +\n                 plot_layout(widths = c(2, 10, 2), heights = c(1, 1))\ncombined_plot\nggsave(\"fig/plot_all.png\", bg = \"white\", width = 10, height = 8)\n```\n\n# Modeling\n\n\n### Fitting\n\n```{r}\nlibrary(lme4)\n\n# Fit a mixed-effects model\nobs_model_lmer <- lmer(mean_yld ~ mean_sev + (1 | trial), data = estria2)\n\n\n# Summary of the model\nsummary(obs_model_lmer)\nconfint(obs_model_lmer)\n\nset.seed(1234)\n\n# Parameters from the fitted model\nfixed_intercept <- 9714.049\nfixed_slope <- -49.378\nrandom_effect_sd <- 905.9  # sqrt(820678)\nresidual_sd <- 970.4       # sqrt(941736)\n\n# Number of experiments and points per experiment\nnum_experiments <- 200  # New experiments\npoints_per_experiment <- 50\n\n# Simulate data\n# Get the range of observed severity values from the original dataset\nset.seed(123)\n\n# Simulate data with variable max severity for each experiment\nsimulated_data_lmer <- data.frame()\nfor (exp in 1:num_experiments) {\n  # Simulate random intercept for the experiment\n  u_j <- rnorm(1, mean = 0, sd = random_effect_sd)\n  \n  # Randomly select a max severity for this simulation between 50% and 80%\n  max_sev_sim <- runif(1, min = 20, max = 80)\n  \n  # Simulate severity values (independent variable) within the 0 to max_sev_sim range\n  sev <- runif(points_per_experiment, min = 0, max = max_sev_sim)\n\n  # Simulate residuals\n  residuals <- rnorm(points_per_experiment, mean = 0, sd = residual_sd)\n  \n  # Generate yield (dependent variable)\n  yld <- fixed_intercept + u_j + fixed_slope * sev + residuals\n  \n  # Combine into a data frame\n  exp_data <- data.frame(experiment = paste0(\"Exp_\", exp), sev = sev, yld = yld)\n  simulated_data_lmer <- rbind(simulated_data_lmer, exp_data)\n}\n\nsimulated_data_lmer$hybrid <- paste0(\"hybrid_\", sprintf(\"%02d\", (seq_len(nrow(simulated_data_lmer)) - 1) %/% 50 + 1))\n# View simulated data\nhead(simulated_data_lmer)\n\nsummary(simulated_data_lmer)\n\nlibrary(ggplot2)\n\n# Compare simulated and real severity-yield relationships\nggplot(simulated_data_lmer, aes(x = sev, y = yld, color = experiment)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  theme_minimal() +\n  theme(legend.position = \"none\")+\n  labs(title = \"Simulated Severity-Yield Data\", x = \"Severity\", y = \"Yield\")\n\n\nsimu_model_lmer <- lmer(yld ~ sev + (1 | experiment), data = simulated_data_lmer)\nsimu_model_lmer\nsummary(simu_model_lmer)\nconfint(simu_model_lmer)\n\n\nobs_fixed_effects_lmer <- fixef(obs_model_lmer)  # From the original model\nsimu_fixed_effects_lmer <- fixef(simu_model_lmer)  # From the simulated model\n\nprint(obs_fixed_effects_lmer)\nprint(simu_fixed_effects_lmer)\n\n\nobs_random_effects_lmer <- VarCorr(obs_model_lmer)\nsimu_random_effects_lmer <- VarCorr(simu_model_lmer)\n\nprint(obs_random_effects_lmer)\nprint(simu_random_effects_lmer)\n\n\nobs_residual_sd_lmer <- attr(VarCorr(obs_model_lmer), \"sc\")\nsimu_residual_sd_lmer <- attr(VarCorr(simu_model_lmer), \"sc\")\n\nprint(obs_residual_sd_lmer)\nprint(simu_residual_sd_lmer)\n\n```\n## Plotting\n```{r}\nlibrary(broom)\nlmer_stats = simulated_data_lmer %>%\n  #group_by(year) %>%\n  dplyr::select(experiment, yld,sev) %>%\n  group_by(experiment) %>%\n  do({\n    model <- lm(.$yld ~ .$sev)\n    tidy_model <- tidy(model)\n    confint_model <- confint(model)  # Calcula os intervalos de confiança\n    bind_cols(tidy_model, confint_model)\n  })\n\n\n\n\nlmer_stats = lmer_stats |> \nfilter(term %in% c(\"(Intercept)\",\".$sev\"))\n \nlmer_stats[lmer_stats$term== \"(Intercept)\",c(\"parameters\")] <- \"Intercept\"\nlmer_stats[lmer_stats$term== \".$sev\",c(\"parameters\")] <- \"Slope\"\n\ni <- 1\n while (i <= nrow(lmer_stats)) {\n  if (lmer_stats$parameters[i] == \"Slope\" && lmer_stats$estimate[i] > 0) {\n    # Remove a linha do Slope e a linha do Intercept correspondente\n    lmer_stats <- lmer_stats[-c(i, i - 1), ]\n    # Atualiza o índice, pois duas linhas foram removidas\n    i <- i - 2\n  }\n  i <- i + 1\n }\nlmer_stats\n\n\nslope_trial_m= lmer_stats |> \n  filter(parameters == \"Slope\") %>% \n  summarise(\n    Slope = estimate\n  )\n\nslope_trial_m[,1] = NULL\n\nslope_trial_m |> \n  filter(!Slope == \"NA\") |> \n  summarise(\nmean = mean(Slope))\n\nintercept_trial_m = lmer_stats |> \n  filter(parameters == \"Intercept\") %>%  \n  summarise(\n    Intercept = estimate\n  )\nintercept_trial_m[,1] = NULL\n\nmean(intercept_trial_m$Intercept)\n\nregression_trial_m = cbind(slope_trial_m,intercept_trial_m)\nregression_trial_m[,3] = NULL\n\nsummary_stats <- regression_trial_m %>%\n  reframe(\n    mean_intercept = mean(Intercept),\n    mean_slope = mean(Slope),\n    ci_intercept_lower = quantile(Intercept, 0.025),\n    ci_intercept_upper = quantile(Intercept, 0.975),\n    ci_slope_lower = quantile(Slope, 0.025),\n    ci_slope_upper = quantile(Slope, 0.975)\n  )\n\nlmer_plot = simulated_data_lmer|> \n ggplot(aes(sev, y = yld)) +\n  geom_point(color = \"NA\")+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  geom_abline(data =regression_trial_m, aes(slope = Slope, intercept = Intercept), size = 1,\n              alpha = 0.5, color = \"grey\")+##9ccb86\n#  geom_abline(data =summary_stats, aes(slope = mean_slope, intercept = mean_intercept),\n #             size = 1.5, fill = \"black\", color = \"black\")+\n  geom_abline(data = summary_stats,aes(intercept = ci_intercept_lower,slope = ci_slope_lower) ,\n              size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline(data = summary_stats, aes(intercept = ci_intercept_upper,slope = ci_slope_upper), size = 1.5, linetype = 2, fill = \"grey\", color = \"grey\")+\n  geom_abline( aes(slope = -49.38, intercept = 9691.0),\n              size = 1.5, fill = \"black\", color = \"black\")+\n  geom_abline(aes(intercept = 9555.81,slope = -50.65) ,\n              size = .51, linetype = 2)+\n  geom_abline(aes(intercept = 9826.19,slope = -48.12), size = .51, linetype = 2)+\n   ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.title = element_text(size = 10, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\", y = \"\",\n       title = \"\")\n\nlmer_plot\n```\n\n\n## Joining\n```{r}\n\nplot_grid(trials,lmer_plot,plot_sev, plot_yld, labels = c(\"(a)\",\"(b)\",\"(c)\",\"(d)\"), ncol = 2,\n          label_size = 10, label_x = -0.01)\n\n\nggsave(\"fig/obs_simu_model.png\", bg = \"white\", dpi = 600,width = 6, height = 4)\n\n```\n\n```{r}\ncor(estria2$mean_sev, estria2$mean_yld)\ncor(simulated_data_lmer$sev, simulated_data_lmer$yld)\n```\n\n# Performance\n\n### Empirical\n```{r}\n\nobs_lmer_predicted <- predict(obs_model_lmer)\n\n\nobs_lmer_observed <- estria2$mean_yld\n\n\nobs_lmer_residuals <- obs_lmer_observed - obs_lmer_predicted\n\n\nobs_lmer_RMSE <- sqrt(mean(obs_lmer_residuals^2))  \nobs_lmer_MAE <- mean(abs(obs_lmer_residuals))     \nobs_lmer_correlation <- cor(obs_lmer_observed, obs_lmer_predicted)\n\nperformance::check_normality(obs_model_lmer)\nperformance::check_heteroscedasticity(obs_model_lmer)\nperformance::check_autocorrelation(obs_model_lmer)\n\n```\n### Simulated\n```{r}\n\nsimu_lmer_predicted <- predict(simu_model_lmer)\n\n\nsimu_lmer_observed <- simulated_data_lmer$yld\n\n\nsimu_lmer_residuals <- simu_lmer_observed - simu_lmer_predicted\n\n\nsimu_lmer_RMSE <- sqrt(mean(simu_lmer_residuals^2))  \nsimu_lmer_MAE <- mean(abs(simu_lmer_residuals))     \nsimu_lmer_correlation <- cor(simu_lmer_observed, simu_lmer_predicted)       \n\nperformance::check_normality(simu_model_lmer)\nperformance::check_heteroscedasticity(simu_model_lmer)\nperformance::check_autocorrelation(simu_model_lmer)\n```\n\n\n## Visualization\n\n#### Simulated\n\n```{r}\n\n# Extrair os resíduos e quantis teóricos\nlmer_residuals <- residuals(simu_model_lmer, type = \"deviance\")\nlmer_qq_data <- data.frame(\n  theoretical = qqnorm(lmer_residuals, plot.it = FALSE)$x*1000,\n  residuals = qqnorm(lmer_residuals, plot.it = FALSE)$y\n)\n\n# Plotar o QQ plot\nlmer_qq = lmer_qq_data %>% \n  ggplot(aes(x = theoretical, y = residuals)) +\n  geom_point() +\n  geom_abline(intercept = 0, slope = 1, color = \"red\", linetype = \"dashed\") +\n  scale_x_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Theoretical Quantiles\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlmer_qq\n```\n\n```{r}\n# Extrair preditores lineares e resíduos\nlmer_linear_predictors <- predict(simu_model_lmer, type = \"link\")\nlmer_residuals_data <- data.frame(\n  linear_predictors = lmer_linear_predictors,\n  residuals = lmer_residuals\n)\n\n# Plotar resíduos vs preditores lineares\nlmer_predictors = lmer_residuals_data %>% \n  ggplot(aes(x = linear_predictors, y = residuals)) +\n  geom_point(alpha = 0.2, color = \"grey\", size = 2) +\n  geom_hline(yintercept = 0, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Linear Predictors\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n```\n\n```{r}\n\n# Calcular média e desvio-padrão dos resíduos\nmean_res <- mean(lmer_residuals_data$residuals)\nsd_res <- sd(lmer_residuals_data$residuals)\n\n# Plotar o histograma e a curva acumulada normal\nlmer_res_hist <- ggplot(lmer_residuals_data, aes(x = residuals)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_res, sd = sd_res), \n                color = \"darkred\", size = 1.2, linetype = \"solid\") + # Adiciona a curva normal\n  scale_x_continuous(breaks = c(-2500, -1250, 0, 1250, 2500), \n                     limits = c(-2500, 2500)) +\n  labs(x = \"Deviance Residuals\", y = \"\") +\n  ggthemes::theme_few() +\n  theme(text = element_text(size = 12, face = \"bold\"))\n\n# Exibir o gráfico\nlmer_res_hist\n\n\n```\n\n```{r}\n# Extrair valores observados e preditos\nlmer_observed <- simulated_data_lmer$yld\nlmer_predicted <- predict(simu_model_lmer, type = \"response\")\nlmer_prediction_data <- data.frame(\n  observed = lmer_observed,\n  predicted = lmer_predicted\n)\n\n# Plotar valores preditos vs observados\nlmer_pd_ob = lmer_prediction_data %>% \n  ggplot(aes(x = observed, y = predicted)) +\n  geom_point(alpha = 0.5, color = \"grey\", size = 2) +\n  geom_abline(intercept = 0, slope = 1, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  labs(x = \"Observed\", y = \"\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nlmer_pd_ob\nmax(lmer_prediction_data$predicted)\n```\n#### Observed\n\n```{r}\n\n# Extrair os resíduos e quantis teóricos\nobs_lmer_residuals <- residuals(obs_model_lmer, type = \"deviance\")\nobs_lmer_qq_data <- data.frame(\n  theoretical = qqnorm(obs_lmer_residuals, plot.it = FALSE)$x*1000,\n  residuals = qqnorm(obs_lmer_residuals, plot.it = FALSE)$y\n)\n\n# Plotar o QQ plot\nobs_lmer_qq = obs_lmer_qq_data %>% \n  filter(!residuals < -2000) %>% \n  ggplot(aes(x = theoretical, y = residuals)) +\n  geom_point() +\n  geom_abline(intercept = 0, slope = 1, color = \"red\", linetype = \"dashed\") +\n   scale_x_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Theoretical Quantiles\", y = \"Dev. Residuals\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nobs_lmer_qq\n```\n\n```{r}\n# Extrair preditores lineares e resíduos\nobs_lmer_linear_predictors <- predict(obs_model_lmer, type = \"link\")\nobs_lmer_residuals_data <- data.frame(\n  linear_predictors = obs_lmer_linear_predictors,\n  residuals = obs_lmer_residuals\n)\n\n# Plotar resíduos vs preditores lineares\nobs_lmer_predictors = obs_lmer_residuals_data %>%\n  filter(!residuals < -2000) %>% \n  ggplot(aes(x = linear_predictors, y = residuals)) +\n  geom_point(alpha = 0.2, color = \"grey\", size = 2) +\n  geom_hline(yintercept = 0, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(-3000,-2000,-1000,0,1000,2000,3000), \n                     limits = c(-3000, 3000))+\n  labs(x = \"Linear Predictors\", y = \"Dev. Residuals\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n```\n\n```{r}\n# Calcular média e desvio-padrão dos resíduos\nmean_res <- mean(obs_lmer_residuals_data$residuals)\nsd_res <- sd(obs_lmer_residuals_data$residuals)\n\n# Plotar o histograma e a curva acumulada normal\nobs_lmer_res_hist <- ggplot(obs_lmer_residuals_data, aes(x = residuals)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_res, sd = sd_res), \n                color = \"darkred\", size = 1.2, linetype = \"solid\") + # Adiciona a curva normal\n  scale_x_continuous(breaks = c(-2500, -1250, 0, 1250, 2500), \n                     limits = c(-2500, 2500)) +\n  labs(x = \"Deviance Residuals\", y = \"Frequency\") +\n  ggthemes::theme_few() +\n  theme(text = element_text(size = 12, face = \"bold\"))\n\n# Exibir o gráfico\nobs_lmer_res_hist\n\n```\n\n```{r}\n# Extrair valores observados e preditos\nobs_lmer_observed <- estria2$mean_yld\nobs_lmer_predicted <- predict(obs_model_lmer, type = \"response\")\nobs_lmer_prediction_data <- data.frame(\n  observed = obs_lmer_observed,\n  predicted = obs_lmer_predicted\n)\n\n# Plotar valores preditos vs observados\nobs_lmer_pd_ob = obs_lmer_prediction_data %>% \n  ggplot(aes(x = observed, y = predicted)) +\n  geom_point(alpha = 0.5, color = \"grey\", size = 2) +\n  geom_abline(intercept = 0, slope = 1, color = \"black\", linetype = \"dashed\", size = 1.4) +\n  scale_x_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  scale_y_continuous(breaks = c(4000,6000,8000,10000,12000), \n                     limits = c(4000, 12000))+\n  labs(x = \"Observed\", y = \"Predicted\") +\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"))\n\nobs_lmer_pd_ob\n```\n\n#### Plotting\n```{r}\n#plot_grid(obs_lmer_pd_ob,lmer_pd_ob,\n #         obs_lmer_qq,lmer_qq,\n  #        obs_lmer_predictors,lmer_predictors,\n   #       obs_lmer_res_hist,lmer_res_hist, ncol = 2, labels = c(\"a\"),\n    #      label_x = -0.01,label_y = 0.01)\n\n(obs_lmer_pd_ob | lmer_pd_ob) / \n(obs_lmer_qq | lmer_qq) / \n(obs_lmer_predictors | lmer_predictors) / \n(obs_lmer_res_hist | lmer_res_hist) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\") &\n  theme(plot.tag = element_text(face = \"bold\", size = 14))\n\n\nggsave(\"fig/lmm_residue.png\", dpi = 600, bg = \"white\", height = 6, width = 8)\n```\n\n# Power analysis of model by simulation\n### Severity\n\n\n```{r,eval = FALSE, echo = TRUE}\nlibrary(simr)\nlibrary(ggplot2)\nlibrary(dplyr)\n\n# Ajuste do modelo original\nsev_lmer <- lmer(mean_yld ~ mean_sev + (1 | trial), data = estria2)\n\n# Criar um modelo extendido para simulação\next_sev_lmer <- extend(sev_lmer, along = \"mean_sev\", n = 10000)\n\n# Rodar várias simulações do powerCurve e armazenar os resultados\nnum_simulations <- 50  # Número de simulações individuais\npower_results <- list()\n\nfor (i in 1:num_simulations) {\n  power_results[[i]] <- as.data.frame(summary(powerCurve(ext_sev_lmer, \n                                                          along = \"mean_sev\", \n                                                          nsim = 100, \n                                                          breaks = 1:100)))\n}\n\n\npower_df <- bind_rows(power_results, .id = \"simulation\")\n\n#write_xlsx(power_df, \"data/power_df.xlsx\")\n\n\n\n```\n\n```{r}\npower_df = read_xlsx(\"data/power_df.xlsx\")\n\n\npower_df2 <- power_df %>%\n  group_by(nlevels) %>%\n  summarise(mean = mean(mean, na.rm = TRUE),\n            lower = mean(lower, na.rm = TRUE),\n            upper = mean(upper, na.rm = TRUE))\n\npower_df %>% \n  filter(mean >= 0.80 & mean <=0.85)\n```\n\n#### Plotting\n\n```{r}\nggplot() +\n  # Linhas cinzas para cada simulação individual\n  geom_line(data = power_df, aes(x = nlevels, y = mean * 100, group = simulation), \n            color = \"gray\", alpha = 0.4) +\n  # Linha da média (laranja)\n  geom_line(data = power_df2, aes(x = nlevels, y = mean * 100), \n            color = \"black\", size = 1.2) +\n  # Linhas superior e inferior (preto, tracejado)\n  geom_line(data = power_df2, aes(x = nlevels, y = upper * 100), \n            color = \"black\", linetype = \"dashed\", size = 0.8) +\n  geom_line(data = power_df2, aes(x = nlevels, y = lower * 100), \n            color = \"black\", linetype = \"dashed\", size = 0.8)+\n  scale_x_continuous(breaks = c(0,5,10,15,20,25,30,35,40,45,50), limits = c(0, 50))+\n  scale_y_continuous(breaks = c(0,10,20,30,40,50,\n                                60,70,80,90,100), limits = c(0, 100))+\n  geom_hline(yintercept = 80, linetype = \"dashed\", size = 1, color = \"darkblue\")+\n  geom_vline(xintercept = c(25), linetype = 2, size = 1, color = \"darkblue\")+\n  coord_cartesian(xlim = c(0,50))+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        legend.position = \"none\")+\n  labs(x = \"Disease severity (%)\",\n       y = \"Power (%)\")\n\nggsave(\"fig/power_model.png\", bg = \"white\", dpi = 600,width = 6, height = 4)\n```\n\n\n# Damage\n\n## Economic losses\n\n```{r}\n\n\nsev  = data.frame(sev = seq(20,100, by = 10))\nyield = data.frame(yld = seq(4000,12000,by = 500))\nprice = data.frame(price = seq(100,300, by = 100))\n\ncombined_data <- expand.grid(sev = sev$sev, yld = yield$yld, price = price$price)\n\nylmer_simu_min = combined_data %>% \n  mutate(loss =((((((49.3/9691.0)*sev)*100)*yld)/100)/1000)*price)\n\n\ncustom_labels <- c(\n  \"100\" = \"100 USD/ton\",\n  \"200\" = \"200 USD/ton\",\n  \"300\" = \"300 USD/ton\"\n)\n\n\n heat_loss =ylmer_simu_min %>%\n   filter(price == \"200\") %>% \n  ggplot(aes(sev,yld, fill = loss)) +\n  geom_tile(color = \"white\", size = 0.8) +\n  scale_x_continuous(breaks = seq(20, 100, by = 10)) +\n  scale_y_continuous(breaks = seq(4000, 12000, by = 500)) +\n  scale_fill_viridis_b(option = \"E\", \n                     guide = guide_colorbar(barwidth = 0.3, barheight = 15), \n                     breaks = seq(0, 2000, by = 300))+\n   geom_text(aes(label = as.integer(loss)),\n    size = 3, colour = \"white\")+\n   #facet_wrap(~price, labeller = as_labeller(custom_labels))+\n  theme_minimal_grid(font_size = 14) +\n  labs(\n    y = \"Attainable yield (kg/ha)\",\n    x = \"Disease severity (%)\",\n    fill = \"L (USD/ha)\"\n  )+\n   theme(text = element_text(size = 14),\n     axis.title = element_text(size = 20, face = \"bold\"),\n    strip.text = element_text(size= 14, vjust = -1),\n    #axis.text.y = element_text(hjust = -3),\n    axis.text.x = element_text(vjust = 3),\n    legend.position = \"right\",\n    legend.justification = 0.5,\n    panel.grid = element_blank())\n\nhist_loss = ylmer_simu_min |>\n  filter(price == \"200\") %>% \n  ggplot(aes(loss))+\n  geom_histogram(color = \"white\", fill= \"#1c1c3c\", bins = 15)+\n  facet_wrap(~price)+\n  ggthemes::theme_few() +\n   scale_x_continuous(breaks = seq(0,2100, by = 300)) +\n  labs(\n    y = \"Frequency\",\n    x = \"Economic losses (USD/ha)\")+\n    theme(\n    text = element_text(face = \"bold\", size = 14),\n    axis.title = element_text(size = 20, face = \"bold\"),\n    axis.text.x = element_text(vjust = 1, size = 14, face = \"bold\"),\n    axis.text.y = element_text(vjust = 1, size = 14, face = \"bold\"),\n    legend.position = \"none\",\n    legend.justification = 0.5,\n    panel.grid = element_blank(),\n    strip.text = element_blank() \n  )\n\nloss_200 = ylmer_simu_min |>\n  filter(price == \"200\") \n\nmedian(loss_200$loss)\n\nhist_loss = ylmer_simu_min %>% \n  filter(price == \"200\") %>%\nggplot(aes(x = loss)) +\n  stat_halfeye(fill = \"#ffc425\", alpha = 0.7)+\n  geom_vline(aes(xintercept = 447.6731), color = \"#1c1c3c\", linetype = \"dashed\", size = 2) +\n  ggthemes::theme_few() +\n   #scale_x_continuous(breaks = seq(0,2100, by = 100)) +\n  scale_x_continuous(breaks=c(50,150,250,350,450,550,\n                              650,750,850,950,1050,\n                              1150,1250,1350,1450,1550,1650,1750,1850,1950,\n                              2150))+\n  labs(\n    y = \"Density\",\n    x = \"Economic losses (USD/ha)\")+\n    theme(\n    text = element_text(face = \"bold\", size = 14),\n    axis.title = element_text(size = 20, face = \"bold\"),\n    axis.text.x = element_text(vjust = 1, size = 14, face = \"bold\"),\n    axis.text.y = element_text(vjust = 1, size = 14, face = \"bold\"),\n    legend.position = \"none\",\n    legend.justification = 0.5,\n    panel.grid = element_blank(),\n    strip.text = element_blank() \n  )\n```\n\n```{r}\n\n# Below 25%\n\nsev_loss_b25  = data.frame(sev = seq(5,25, by = 5))\n\ncombined_data_b25 <- expand.grid(sev = sev_loss_b25$sev, yld = yield$yld)\n\nloss_25 = ((((((49.3/9691.0)*25)*combined_data_b25$sev)*combined_data_b25$yld)/100)/1000)*200\n\nmean(loss_25)\nmin(loss_25)\nmax(loss_25)\n\n# Above 25%\n\nsev_loss_a25  = data.frame(sev = seq(25,100, by = 5))\n\ncombined_data_a25 <- expand.grid(sev = sev_loss_a25$sev, yld = yield$yld)\n\nloss_25 = ((((((49.3/9691.0)*combined_data_a25$sev)*combined_data_a25$sev)*combined_data_a25$yld)/100)/1000)*200\n\nmean(loss_25)\nmin(loss_25)\nmax(loss_25)\n```\n\n```{r}\n\n(hist_loss+heat_loss) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 24)) \n\n ggsave(\"fig/loss.png\", bg = \"white\",\n       dpi = 600,height =8, width = 16)\n```\n\n## Relative yield\n\n```{r}\n\nlmer_slope= lmer_stats %>% \n  filter(parameters == \"Slope\")\n\nlibrary(minpack.lm)\nFx =environment(ecdf(-lmer_slope$estimate))$y\nx = environment(ecdf(-lmer_slope$estimate))$x\n\nslope_reg = nlsLM(Fx ~ pgamma(x, shape, rate,log = FALSE) ,\n      start = c(shape = 2.5, rate = 0.13),\n      control = nls.lm.control(maxiter = 1024))\nsummary(slope_reg)\n\n\nshape_res = summary(slope_reg)$coef[1]\nrate_res = summary(slope_reg)$coef[2]\nks.test(Fx, pgamma(x, shape_res, rate_res))\n\n\nslope_plot = lmer_slope %>% \n  ggplot(aes(x = estimate)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun=function(x) dgamma(-x, shape_res, rate_res), size = 1.2, color = \"darkblue\")+\n  ggthemes::theme_few()+\n  #facet_wrap(~approach)+\n  labs(x = \"Slope (kg/p.p)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"))\n\n\n\n\nlmer_intercept= lmer_stats %>% \n  filter(parameters == \"Intercept\")\n\nshapiro.test(lmer_slope$estimate)\n\nmean_intercept = mean(lmer_intercept$estimate)\nsd_intercept = sd(lmer_intercept$estimate)\n\nintercept_plot <- lmer_intercept %>% \n  ggplot(aes(x = estimate)) +\n  geom_histogram(aes(y = ..density..), fill = \"black\", color = \"white\", bins = 20) + # Ajusta para densidade\n  stat_function(fun = dnorm, args = list(mean = mean_intercept, sd = sd_intercept), \n                color = \"darkblue\", size = 1.2, linetype = \"solid\")+\n  ggthemes::theme_few()+\n  #facet_wrap(~approach)+\n  labs(x = \"Intercept (kg/ha)\",\n       y = \"Frequency\")+\n  theme(text = element_text(size = 10, face = \"bold\"))\n\n\n```\n\n```{r}\n\nset.seed(1)\n\nu_j <- rnorm(100, mean = 0, sd = random_effect_sd)\n\n#mean_uj = mean(u_j)\n\ndf <- expand.grid(sev = seq(0, 100, by = 1), rep = 1:100)\ndf$yield = 9691.0 - 49.38*df$sev - rep(u_j, each = 101)\ndf$relative <- df$yield *100 / 9691.0\n\ndf2 = df %>% \n  group_by(sev) %>% \n  summarise(mean = mean(relative),\n     up_95 = quantile(relative, 0.975),\n     low_95 = quantile(relative, 0.025))\n\n\n\nrelative_plot = ggplot() +\n  geom_line(data = df, aes(x = sev, y = relative, group = rep), \n            color = \"grey\", alpha = 0.4) +  # Linhas cinzas para cada simulação\n  geom_line(data = df2, aes(x = sev, y = mean), \n            color = \"black\", size = 1.4) +  # Linha média\n  geom_line(data = df2, aes(x = sev, y = up_95), \n            color = \"black\", linetype = \"dashed\",size = 1) +  # IC superior\n  geom_line(data = df2, aes(x = sev, y = low_95), \n            color = \"black\", linetype = \"dashed\",size = 1) +  # IC inferior\n  scale_y_continuous(breaks = c(20,30, 40,50, 60,\n                                70,80,90,100), \n                     limits = c(20, 100),\n                     expand = c(0, 2))+\n  scale_x_continuous(breaks = c(0,10,20,30,40,50,60,70,80,90, 100),\n                     limits = c(0, 100),\n                     expand = c(0, 2))+\n  coord_cartesian(xlim = c(0,100), ylim = c(20,100))+\n  labs(x = \"Disease severity (%)\", y = \"Relative yield (%) \")+\n  geom_hline(yintercept = 87,\n             linetype = 2, color = \"darkblue\", size = 1)+\n  geom_vline(xintercept = c(25), linetype = 2, color = \"darkblue\", size = 1)+\n  ggthemes::theme_few()+\n  theme(text = element_text(size = 10, face = \"bold\"),\n        axis.text.x = element_text(size = 10, face = \"bold\"),   \n        axis.text.y = element_text(size = 10, face = \"bold\"))\n```\n\n```{r}\n\nlibrary(patchwork)\n\n#plot_grid(slope_plot / intercept_plot | relative_plot, ncol = 1,\n #         label_x = -0.02, label_size = 12)\n\n(slope_plot / intercept_plot |relative_plot) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 12))\n\nggsave(\"fig/relative_parameters.png\", bg = \"white\", dpi = 600,\n       height = 4, width = 6)\n\n\n```\n\n# Break-even probability\n\n## Framework simulation\n\n### NORTA function\n```{r}\ngera.norm.bid.geral<-function(tamanho.amostra,correlacao,m1,m2,sigma1,sigma2)\n{\n  ro<-correlacao\n  n<-tamanho.amostra\n  x<-matrix(0,n,2)\n  for (i in 1:n)\n  {x[i,1]<-rnorm(1,m1,sigma1)\n  x[i,2]<-rnorm(1,m2+ro*sigma1/sigma2*(x[i,1]-m1),sigma2*(sqrt(1-ro^2)))\n  }\n  return(x)\n}\n\ngc()\n```\n```{r}\nestria2 %>% \n  ggplot(aes(mean_sev))+\n  geom_histogram(color= \"white\", fill = \"black\")+\n  ggthemes::theme_few()\n```\n### Severity\n```{r}\n\nlibrary(minpack.lm)\n  \nsev = simulated_data_lmer$sev\n#sev = estria2$mean_sev\nFx_sev = environment(ecdf(sev))$y\nx_sev = environment(ecdf(sev))$x/100\n\nsummary(nlsLM(Fx_sev ~ pbeta(x_sev, shape1, shape2, log = FALSE) ,\n      start = c(shape1 = 1, shape2 = 1),\n      control = nls.lm.control(maxiter = 100000)))\n```\n\n```{r}\nks.test(Fx_sev,pbeta(x_sev,1.2041125,3.6414300))\n```\n```{r}\nplot(x_sev,Fx_sev)\ncurve(pbeta(x, 1.2041125,3.6414300),0,1, add = T)\n```\n### Intercept\n```{r}\n\nintercept_bls = regression_trial_m\nintercept_bls[,1] = NULL\n\nmean_intercept = mean(intercept_bls$Intercept)\nsd_intercept = sd(intercept_bls$Intercept)\n\nplot(ecdf(intercept_bls$Intercept))\ncurve(pnorm(x, mean_intercept,sd_intercept), add = T, col = \"red\")\n\n\n```\n```{r}\nFx_res_b0 = environment(ecdf(intercept_bls$Intercept))$y\nx_res_b0= environment(ecdf(intercept_bls$Intercept))$x\nks.test(Fx_res_b0, pnorm(x_res_b0, mean(intercept_bls$Intercept), sd(intercept_bls$Intercept)))\n```\n\n### Slope\n```{r}\nslope_bls = regression_trial_m\nslope_bls[,2] = NULL\n  \n\nmean_slope = mean(slope_bls$Slope)\nsd_slope = sd(slope_bls$Slope)\n\nplot(ecdf(slope_bls$Slope))\ncurve(pnorm(x, mean_slope, sd_slope), add = T, col = \"red\")\n```\n```{r}\nlibrary(minpack.lm)\nFx =environment(ecdf(-slope_bls$Slope))$y\nx = environment(ecdf(-slope_bls$Slope))$x\n\nslope_reg = nlsLM(Fx ~ pgamma(x, shape, rate,log = FALSE) ,\n      start = c(shape = 2.5, rate = 0.13),\n      control = nls.lm.control(maxiter = 1024))\nsummary(slope_reg)\n```\n```{r}\nshape = summary(slope_reg)$coef[1]\nrate = summary(slope_reg)$coef[2]\n\nFx =environment(ecdf(-slope_bls$Slope))$y\nx = environment(ecdf(-slope_bls$Slope))$x\nks.test(Fx, pgamma(x, shape, rate))\n```\n\n```{r}\ncor(regression_trial_m$Slope,regression_trial_m$Intercept)\n```\n```{r}\nj_res<-gera.norm.bid.geral(10000,0.15,0,0,1,1)\n\nplot(j_res[,1],j_res[,2])\n```\n### Corn price\n\n```{r}\ncorn = gsheet2tbl(\"https://docs.google.com/spreadsheets/d/1LcLVKb6bW7tVaiu6reLsT8sjFR1hwUcembZ7uxAoBP8/edit?usp=sharing\") \n\ncorn = corn %>%\n  filter(state %in% c(\"PR\")) %>% \n  filter(year <= 2019)\n\n```\n\n```{r}\nbls_price = corn %>%\n  #filter(year <= 2019) %>%\n  mutate(price = (price/60)/4)\nbls_price\n\nmin(bls_price$price)\nmean(bls_price$price)\n```\n\n```{r}\nmean(bls_price$price)\nmedian(bls_price$price)\nsd(bls_price$price)\n```\n\n\n```{r}\nbls_price %>% \n  ggplot(aes(price))+\n  geom_histogram(fill = \"steelblue\", color = \"white\", bins = 10)+\n ggthemes::theme_few()+\n  labs(x = \"Soybean prince\",\n       y = \"Frequency\")+\n  scale_x_continuous(breaks = seq(0,1,by=0.025))+\n  theme(text = element_text(size = 12, face = \"bold\"),\n        axis.title = element_text(size = 14, face = \"bold\"),\n        legend.position = \"none\")\n\n```\n\n```{r}\nhist((bls_price$price), prob = T)\ncurve(dnorm(x, mean(bls_price$price), sd(bls_price$price)),0.15,0.35, add = T)\n```\n\n```{r}\nplot(ecdf(bls_price$price))\ncurve(pnorm(x, mean(bls_price$price), sd(bls_price$price)),0.2,0.35, add = T)\n```\n\n```{r}\nmean(bls_price$price)\nmedian(bls_price$price)\n```\n\n```{r}\nshapiro.test(bls_price$price)\n```\n\n#### Kolmogorov-Smirnov Test\n\n```{r}\nFx = environment(ecdf(bls_price$price))$y\nx= environment(ecdf(bls_price$price))$x\nks.test(Fx, pnorm(x, mean(bls_price$price), sd(bls_price$price)))\n```\n\n```{r}\nplot(Fx, pnorm(x, mean(bls_price$price), sd(bls_price$price)))\n```\n\n#### Vizualization\n\n```{r}\nprice_plot = bls_price %>% \n  ggplot(aes(price))+\n geom_histogram(aes(y = ..density..),bins = 10, color = \"white\", fill = \"black\")+ #\"#1C8C20\"\n   #stat_function(fun=function(x) dnorm(x, mean(sbr_price$price), sd(sbr_price$price)), color= \"black\", size = 1.2)+\n  ggthemes::theme_few()+\n  labs(x=\"Soybean price (USD/kg)\", y = \"Frequency\")+\n  scale_x_continuous(breaks = seq(0,1,by=0.025))+\ntheme(text = element_text(size = 12, face = \"bold\"),\n        axis.title = element_text(size = 14, face = \"bold\"),\n        legend.position = \"none\")\nprice_plot\n\n  ggsave(\"fig/soybean_price.png\", bg = \"white\",\n       dpi = 600, height = 5, width = 6)\n```\n\n## Simulation\n\n```{r,eval = FALSE, echo = TRUE}\nset.seed(1)\nn=40000\nlambda = seq(0,1, by=0.05)\nfun_price = seq(-10, 260, by=15)\nn_aplication = 1\noperational_cost = 10  \n\ncomb_matrix = as.matrix(data.table::CJ(lambda,fun_price))\ncolnames(comb_matrix) = c(\"lambda\",\"fun_price\")\ncomb_matrix = cbind(comb_matrix,operational_cost, n_aplication)\nC = comb_matrix[,\"n_aplication\"]*(comb_matrix[,\"operational_cost\"]+comb_matrix[,\"fun_price\"] )\ncomb_matrix = cbind(comb_matrix,C)\n\nN = length(comb_matrix[,1])*n\nbig_one = matrix(0, ncol = 12, nrow =N)\nbig_one[,1] = rep(comb_matrix[,1],n)\nbig_one[,2] = rep(comb_matrix[,2],n)\nbig_one[,3] = rep(comb_matrix[,3],n)\nbig_one[,4] = rep(comb_matrix[,4],n)\nbig_one[,5] = rep(comb_matrix[,5],n)\n\nset.seed(1)\n\n\nsn = rbeta(N, 1.2041125,3.6414300)\nsf = sn*(1-big_one[,1])\n\n# simulating the coeficientes \n\n\nset.seed(1)\nnormal_correlated<-gera.norm.bid.geral(N,0.15,0,0,1,1)\nb0_n = pnorm(normal_correlated[,2])\nb1_n = pnorm(normal_correlated[,1])\nb0 = qnorm(b0_n, mean_intercept,sd_intercept)\nb1 = -qgamma(b1_n, shape, rate,)\nrm(b0_n,b1_n,normal_correlated)\n\n\n# Calculating the alha coeficient\n\n\nalfa = (b1/b0)*100\n\n# Calculating yield gain\n\n## Moderate Resistant (MR)\n\nyn  = b0 - (-alfa*b0*sn)\nyf  = b0 - (-alfa*b0*sf)\n\n\n# Simulating soybean price\n\nset.seed(1)\nsoy_price = rnorm(N, mean(bls_price$price),sd(bls_price$price))\n\n#income = yield_gain*soy_price # calculating the income\n\nbig_one[,6] = yn\nbig_one[,7] = yf\nbig_one[,8] = b1\nbig_one[,9] = b0\nbig_one[,10] = sn\nbig_one[,11] = sf\nbig_one[,12] = soy_price\ncolnames(big_one)  = c(\"lambda\",\"fun_price\",\"operational_cost\",\"n_aplication\",\"C\",\"yn\",\"yf\",\n                       \"b1\",\"b0\",\"sn\",\"sf\",\"soy_price\")\n```\n\n```{r,eval = FALSE, echo = TRUE}\nbig_one_df = as.data.frame(big_one) %>% \n  filter(b0>=0) %>% \n  filter(yn>0) %>% \n  filter(alfa > -3 & alfa < 0) %>%\n  mutate(yield_gain = yf-yn,\n         yield_gain_perc = ((yf/yn)-1)*100,\n         income = yield_gain*soy_price,#0.2\n         CP = C/soy_price,#0.2\n         profit = (income>=C)*1) %>% \n        filter(C <= 180) %>%\n        filter(lambda >= 0.4) %>%\n        filter(lambda <= 0.8)\n\ngc()\n```\n\n```{r}\n#write_csv(big_one_df,\"data/big_one_df.csv\")\nbig_one_df = read_csv(\"data/big_one_df.csv\")\n```\n\n```{r}\nsn = big_one_df %>% \n  ggplot(aes(sn))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n  theme(text = element_text(face = \"bold\", size = 14),\n        axis.title = element_text(face = \"bold\",size = 16))+\n  labs(y = \"Frequency\",\n       x = \"BLS severity (%)\")+\n  ggthemes::theme_few()\n\ngc()\n\n```\n\n```{r}\nb0_graphic = big_one_df %>% \n  ggplot(aes(b0))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n   #scale_x_continuous(breaks = c(0,1000,2000,3000,4000,5000,6000,7000), limits = c(0, 7000))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Intercept (kg/ha)\")+\n  ggthemes::theme_few()\n\ngc()\n```\n```{r}\nb1_graphic = big_one_df %>% \n  ggplot(aes(b1))+\n  geom_histogram(color = \"white\", fill = \"steelblue\", bins = 10, alpha= .5)+\n  #scale_x_continuous(breaks = c(-100,-90,-80,-70,-60,-50,-40,-30,-20,-10,0), limits = c(-100,0))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Slope (kg/p.p.)\")+\n  ggthemes::theme_few()\n\ngc()\n\nb1_graphic\n```\n```{r,eval = FALSE, echo = TRUE}\nalpha_graphic = big_one_df %>% \n    filter(C <= 180) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 60) %>%\n  ggplot(aes(alfa))+\n  geom_histogram(color = \"white\", fill = \"black\", bins = 10)+\n  #scale_x_continuous(breaks = c(-2.0,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,0.0), limits = c(-2.0,0.0))+\n  theme(text = element_text(face = \"bold\", size = 14),\n         axis.title = element_text(size = 16, face = \"bold\"))+\n  labs(y = \"Frequency\",\n       x = \"Yield loss (%/p.p.)\")+\n  ggthemes::theme_few()\n\ngc()\n\nalpha_graphic\n\n```\n\n```{r,eval = FALSE, echo = TRUE}\n#alpha_res_graphic,alpha_m_sus_graphic,alpha_sus_graphic,\nplot_grid(sn_res_graphic,b0_res_graphic,b1_res_graphic, ncol = 3,  labels = c(\"(a)\", \"(b)\", \"(c)\"),label_x = -0.03)\n\nggsave(\"fig/simulated_variables.png\", dpi = 1000, bg = \"white\",\n       height = 8, width = 12)\n```\n\n```{r}\n\nheat <- big_one_df %>%\n  filter(C <= 180) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 15) %>%\n  group_by(lambda, C) %>%\n  summarise(n = n(), sumn = sum(profit), prob = sumn / n) \n\ngc()\n```\n```{r}\nheat_graphic = heat %>% \n  ggplot(aes(as.factor(lambda * 100), as.factor(C), fill = prob)) +\n  geom_tile(size = 0.5, color = \"white\") +\n  scale_fill_viridis_b(option = \"D\", direction = -1) +\n  scale_color_manual(values = c(\"#E60E00\", \"#55E344\")) +\n  guides(color = guide_legend(override.aes = list(size = 2))) +\n  labs(x = \"Fungicide efficacy (%)\",\n       y = \"Fungicide + Application cost ($)\",\n       fill = \"Pr(I \\u2265 C)\",\n       color = \"\") +\n # facet_wrap(vars(class, class2)) +\n  ggthemes::theme_few()+\n  theme(strip.text = element_text(face = \"bold\", size = 14),\n        text = element_text(face = \"bold\", size = 14))\n\n\ngc()\n```\n\n```{r}\nbig = big_one_df %>%\n   mutate(class = case_when(sn > 0.25 ~ \"High severity\",\n                           sn <= 0.25 ~\"Low severity\"))\n```\n\n```{r}\n\nclass <- big %>%\n  filter(C <= 105) %>%\n  filter(lambda >= 0.4) %>%\n  filter(lambda <= 0.8) %>%\n  filter(C >= 15) %>%\n  group_by(lambda, C, class) %>%\n  summarise(n = n(), sumn = sum(profit), prob = sumn / n, .groups = 'drop') %>%\n  ungroup()  \n\ngc()\n```\n```{r}\nlibrary(viridis)\nheat_graphic = class %>% \n  filter(!is.na(class)) %>% \n  ggplot( aes(as.factor(lambda * 100), as.factor(C), fill = prob)) +\n  geom_tile(size = 0.5, color = \"white\") +\n  #geom_text(aes(label = paste(round(prob, 2), sep = \"\")),\n   # size = 4, colour = \"white\")+\n  scale_fill_viridis_b(option = \"E\", direction =  -1)+\n  #scale_fill_viridis(discrete = T, option = \"E\") +\n  guides(color = guide_legend(override.aes = list(size = 2))) +\n  labs(x = \"Treatment efficacy (%)\",\n       y = \"Treatment cost (USD/ha)\",\n       fill = \"Pr(I \\u2265 C)\",\n       color = \"\") +\n  facet_wrap(vars(class), ncol =1) +\n  ggthemes::theme_few()+\n  theme(strip.text = element_text(face = \"bold\", size = 14),\n        text = element_text(face = \"bold\", size = 14),\n        legend.position = \"right\")\n\ngc()\n```\n\n\n```{r}\nlow_class = class %>% \n  filter(class == \"Low severity\")\n\nmin(low_class$prob)\nmax(low_class$prob)\nmean(low_class$prob)\n\nlow_class %>% \n  filter(C <= 15)\n\nhigh_class = class %>% \n  filter(class == \"High severity\")\n\nmin(high_class$prob)\nmax(high_class$prob)\nmean(high_class$prob)\n\n\n```\n\n\n\n```{r}\noverall = big %>%\n  filter(C <= 105) %>%\n  filter(C >= 15) %>%\n  #mutate(sev_class = \" Overall\") %>% \n  dplyr::group_by(lambda,class) %>% \n  summarise(yield_gain_median = median(yield_gain),\n            yield_gain_mean = mean(yield_gain),\n            up_95 = quantile(yield_gain, 0.975),\n            low_95 = quantile(yield_gain, 0.025),\n            up_75 = quantile(yield_gain, 0.75),\n            low_75 = quantile(yield_gain, 0.25)) \n```\n```{r}\n\n\n gain_graphic = overall %>% \n  ggplot(aes(lambda*100,yield_gain_mean))+\n  geom_line(aes(lambda*100, low_95),\n              linetype = 2,\n            size = 1,\n            fill = NA, color = \"black\")+\n  geom_line(aes(lambda*100, up_95),\n              linetype = 2,\n            size = 1,\n          fill = NA,color = \"black\")+\n  geom_line(size = 1.4, aes(lambda*100,yield_gain_median), color = \"#ffc425\")+\n   #scale_y_continuous(breaks = c(0, 500, 1000, 1500,2000,\n    #                             2500, 3000), \n     #                 limits = c(0, 3000))+\n   #scale_x_continuous(breaks = c(40,50,60,70,80), limits = c(40, 80))+\n  #scale_color_viridis_d()+\n  #scale_color_manual(values = c('steelblue', '#9ccb86', 'darkred'))+\n  ggthemes::theme_few()+\n  facet_wrap(~class, ncol = 1)+\n  #facet_wrap(~class+class2)+\n  labs(x = \"Treatment efficacy (%)\",\n       y = \"Yield difference (kg/ha)\",\n       color = \"Tolerance level\", \n       linetype = \"\", fill = \"\")+\n  theme(text = element_text(face = \"bold\", size = 14),\n        strip.text = element_text(size = 14),\n        legend.position = \"top\")\n```\n```{r}\nlibrary(cowplot)\n\n(gain_graphic+heat_graphic) +\n  plot_annotation(tag_levels = \"a\", tag_prefix = \"(\", tag_suffix = \")\")&\n  theme(plot.tag = element_text(face = \"bold\", size = 16))\n\nggsave(\"fig/break-even_gain.png\", dpi = 600, bg = \"white\",\n       width = 8, height = 6)\n```\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"about.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","editor":"visual","theme":"Minimalist","title":"","message":false},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}